<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/template.xhtml">

<ui:define name="toolbar">
    <h:outputStylesheet>
        .barsearch {
            height: 14px;
            width: 100px;
        }

        .autoCompleteWidth50 {
            width: 80px !important;
        }

        .rf-au-lst-scrl {
            width: 80px !important;
        }

        .autoCompletePopupHieght {
            width: 80px !important;
        }
    </h:outputStylesheet>

    <ui:include src="/templates/erp/StoreAreaSelectTree.xhtml">
        <ui:param name="render" value="storeAreaField,inventoryResult"/>
        <ui:param name="store" value="#{storeOutAction.selectStore.getRootStoreAreaList(false)}"/>
    </ui:include>

    <ui:include src="/templates/erp/ResSelectTree.xhtml">
        <ui:param name="render" value="itemFormats,inventoryResult"/>
    </ui:include>

    <h:form id="actions">
        <rich:toolbar height="26" rendered="#{not empty storeOutAction.selectStore}">

            <rich:toolbarGroup>
                <a:region>
                    <h:panelGrid id="resSearchForm" columns="3">


                        <h:inputText styleClass="barsearch" id="resItemCode" value="#{resLocateHome.code}"
                                     required="true">
                            <rich:placeholder value="#{messages.res_field_code}"/>
                        </h:inputText>


                        <a:commandButton value="#{messages.search}" execute="@region"
                                         render="itemFormats,resSearchForm,inventoryResult"
                                         action="#{resLocateHome.locateByCode}">
                            <a:attachQueue requestDelay="0"/>
                        </a:commandButton>


                        <a:commandButton image="/img/onetomany.gif" execute="@this" immediate="true"
                                         title="#{messages.resSelect}"
                                         onclick="#{rich:component('resSelectPanel')}.show();return false;">
                            <a:attachQueue requestDelay="0"/>
                        </a:commandButton>
                    </h:panelGrid>
                </a:region>
            </rich:toolbarGroup>

            <rich:toolbarGroup location="right">
                <a:region>
                    <h:panelGrid columns="3">
                        <h:inputText id="storeOrderCodeInput"
                                     disabled="#{storeOutAction.managed}"
                                     required="true"
                                     maxlength="32"
                                     styleClass="barsearch"
                                     label="#{messages.storeOut_field_id}"
                                     value="#{storeOutAction.instance.id}">
                            <rich:placeholder value="#{messages.storeOut_field_id}"/>
                        </h:inputText>

                        <a:commandButton value="#{messages.StoreOut}" execute="@region"
                                         action="#{storeOutAction.storeOut}"
                                         render="storeOutItem,inventoryResult,storeOutItems,actions,beginActions">
                            <a:attachQueue requestDelay="500"/>
                        </a:commandButton>
                        <a:commandButton value="#{messages.cancel}" immediate="true"
                                         action="#{storeOutAction.clearInstance}"
                                         execute="@this"
                                         render="storeOutItem,inventoryResult,storeOutItems,actions,beginActions">
                            <s:conversationPropagation type="end"/>
                            <a:attachQueue requestDelay="0"/>

                        </a:commandButton>
                    </h:panelGrid>
                </a:region>

            </rich:toolbarGroup>

        </rich:toolbar>
    </h:form>
</ui:define>


<ui:define name="body">
<h:form id="beginActions">
    <a:outputPanel rendered="#{empty storeOutAction.selectStore}">
        <rich:toolbar height="26">
            <rich:toolbarGroup location="right">
                <a:commandButton value="#{messages.beginStoreOut}" action="#{storeOutAction.beginStoreOut}"
                                 execute="@form"
                                 render="storeOutItem,inventoryResult,storeOutItems,storeAreaSelectPanel_form,actions,beginActions,resSelectPanel_form">
                    <a:attachQueue requestDelay="0"/>
                </a:commandButton>
            </rich:toolbarGroup>
        </rich:toolbar>

        <s:decorate id="selectStoreField" template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.Store}</ui:define>
            <rich:select label="#{messages.Store}" required="true" value="#{storeOutAction.selectStore}">
                <s:selectItems value="#{myStores}" var="_store" itemValue="#{_store}"
                               label="#{_store.name}"/>
                <f:converter converterId="erpEntityConverter"/>
            </rich:select>
        </s:decorate>

        <s:decorate id="reasonField" template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.storeOut_field_reason}</ui:define>

            <rich:select label="#{messages.storeOut_field_reason}" value="#{storeOutAction.instance.reason}"
                         required="true">
                <s:selectItems value="#{dictionary.getWordList('erp.storeOutReason')}" var="_word"
                               itemValue="#{_word.id}" label="#{_word.value}"
                               noSelectionLabel="#{messages.noSelectLabel}"/>
            </rich:select>
        </s:decorate>

        <s:decorate id="operDateField" template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.storeOut_field_dateTime}</ui:define>
            <rich:calendar
                    enableManualInput="true"
                    inputSize="20"
                    timeZone="#{calendarBean.timeZone}" locale="#{calendarBean.locale}"
                    showApplyButton="#{calendarBean.showApply}" popup="#{calendarBean.popup}"
                    datePattern="#{messages.datetimepattern}"
                    defaultTime="#{currentTime}"
                    defaultLabel="#{org.jboss.seam.framework.currentDatetime}"
                    required="true"
                    label="#{messages.storeIn_field_dateTime}"
                    value="#{storeOutAction.storeOutDate}"/>
        </s:decorate>

        <s:decorate id="memoField" template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.field_memo}</ui:define>
            <h:inputTextarea
                    cols="80"
                    rows="2"
                    label="#{messages.field_memo}"
                    value="#{storeOutAction.memo}"/>
        </s:decorate>


        <div style="clear:both">
            <span class="required">*</span>
            #{messages.requiredFields}
        </div>

    </a:outputPanel>
</h:form>

<h:form id="storeOutItem">
    <rich:collapsiblePanel header="#{messages.StoreOutInventorySearch}" switchType="client"
                           rendered="#{(not empty storeOutAction.selectStore)}">
        <rich:panel>
            <h:panelGrid id="storeAreaField" columns="4">
                <h:outputText value="#{messages.StoreArea}" styleClass="name"/>
                <h:outputText value="#{storeOutAction.selectStore.name}:"/>
                <a:commandLink
                        value="#{storeAreaHome.idDefined ? storeAreaHome.storeAreaTitle : messages.pleaseSelectStoreArea}"
                        immediate="true" execute="@this"
                        onclick="if(#{empty storeOutAction.selectStore}){alert('#{messages.plaseSelectStore}');}else{#{rich:component('storeAreaSelectPanel')}.show();}return false;">
                    <a:attachQueue requestDelay="0"/>
                </a:commandLink>
                <a:commandButton render="storeAreaField,inventoryResult" rendered="#{storeAreaHome.idDefined}"
                                 title="#{messages.clear}" image="/img/delete.png"
                                 action="#{inventoryList.first}" execute="@this" immediate="true">
                    <a:attachQueue requestDelay="0"/>
                    <a:param value="" assignTo="#{storeAreaHome.id}"/>
                </a:commandButton>
            </h:panelGrid>


            <a:region>
                <a:outputPanel id="itemFormats">
                    <h:panelGrid columns="3">
                        <h:outputText value="#{messages.res}" styleClass="name"/>


                        <a:commandLink value="#{resLocateHome.idDefined ? resLocateHome.resTitle : messages.resSelect}"
                                       execute="@this" immediate="true"
                                       title="#{messages.resSelect}"
                                       onclick="#{rich:component('resSelectPanel')}.show();return false;">
                            <a:attachQueue requestDelay="0"/>
                        </a:commandLink>

                        <a:commandButton render="itemFormats,inventoryResult"
                                         rendered="#{resLocateHome.idDefined}" title="#{messages.clear}"
                                         image="/img/delete.png" action="#{storeResFormatFilter.clearRes}"
                                         execute="@this" immediate="true">
                            <a:attachQueue requestDelay="0"/>
                            <a:param value="" assignTo="#{resLocateHome.id}"/>
                            <a:param value="0" assignTo="#{inventoryList.firstResult}"/>
                        </a:commandButton>
                    </h:panelGrid>

                    <a:repeat value="#{storeResFormatFilter.resFormatList}" var="_format">
                        <s:decorate id="#{_format.formatDefine.id}Field" template="/layout/seam-edit.xhtml">
                            <ui:define name="label">#{_format.formatDefine.name}</ui:define>
                            <ui:include src="/templates/erp/ResFormatVarInput.xhtml">
                                <ui:param name="format" value="#{_format}"/>
                                <ui:param name="render" value="#{_format.formatDefine.id}Field"/>
                                <ui:param name="requiredField" value="false"/>
                                <ui:param name="ajaxDisable" value="true"/>
                            </ui:include>
                        </s:decorate>

                    </a:repeat>

                    <div style="clear:both"/>
                </a:outputPanel>


                <div class="actionButtons">
                    <a:outputPanel id="searchButton">
                        <a:commandButton execute="@region" value="#{messages.search}"
                                         render="itemFormats,inventoryResult"
                                         action="#{inventoryList.first}">
                            <a:attachQueue requestDelay="0"/>
                        </a:commandButton>
                    </a:outputPanel>
                </div>
            </a:region>
        </rich:panel>
        <a:outputPanel id="inventoryResult">
            <a:region>
                <rich:dataTable rendered="#{(not empty storeOutAction.selectStore)}" style="width: 100%"
                                value="#{inventoryList.resultList}" var="_inventory">
                    <rich:column>
                        <f:facet name="header">
                            <f:facet name="header">
                                <ui:include src="/layout/a4jSort.xhtml">
                                    <ui:param name="render" value="inventoryResult"/>
                                    <ui:param name="entityList" value="#{inventoryList}"/>
                                    <ui:param name="propertyLabel" value="#{messages.res}"/>
                                    <ui:param name="propertyPath" value="stock.storeRes.res.name"/>
                                </ui:include>
                            </f:facet>
                        </f:facet>

                        #{_inventory.storeRes.res.name}(#{_inventory.storeRes.res.code}) #{' '}
                        <a:repeat value="#{_inventory.storeRes.formatList}" var="_format">
                            #{' '}
                            #{_format.formatDefine.name} :
                            <h:outputText value="#{dictionary.getWordValue(_format.formatValue)}"
                                          rendered="#{_format.formatDefine.dataType.name() eq 'WORD'}"/>
                            <h:outputText value="#{_format.formatValue}"
                                          rendered="#{not (_format.formatDefine.dataType.name() eq 'WORD')}"/>

                        </a:repeat>
                    </rich:column>


                    <rich:column>
                        <f:facet name="header">
                            <f:facet name="header">
                                <ui:include src="/layout/a4jSort.xhtml">
                                    <ui:param name="render" value="inventoryResult"/>
                                    <ui:param name="entityList" value="#{inventoryList}"/>
                                    <ui:param name="propertyLabel" value="#{messages.StoreArea}"/>
                                    <ui:param name="propertyPath" value="stock.storeArea.name"/>
                                </ui:include>
                            </f:facet>
                        </f:facet>
                        #{_inventory.storeArea.getTitle(false)}

                    </rich:column>
                    <rich:column>
                        <f:facet name="header">
                            <f:facet name="header">
                                <ui:include src="/layout/a4jSort.xhtml">
                                    <ui:param name="render" value="inventoryResult"/>
                                    <ui:param name="entityList" value="#{inventoryList}"/>
                                    <ui:param name="propertyLabel" value="#{messages.InventoryCount}"/>
                                    <ui:param name="propertyPath" value="stock.count"/>
                                </ui:include>
                            </f:facet>
                        </f:facet>
                        #{_inventory.count}

                    </rich:column>

                    <rich:column>
                        <f:facet name="header">
                            #{messages.action}
                        </f:facet>
                        <a:commandButton image="/img/addItem.png" title="#{messages.addItem}" immediate="true"
                                         action="#{storeOutAction.addItem}"
                                         execute="@this" render="storeOutItems,inventoryResult"
                                         rendered="#{not storeOutAction.inventoryInOrder(_inventory.id)}">
                            <a:attachQueue requestDelay="0"/>
                            <a:param value="#{_inventory.id}" assignTo="#{storeOutAction.selectInventoryId}">
                                <a:attachQueue requestDelay="0"/>
                            </a:param>
                        </a:commandButton>
                    </rich:column>

                    <f:facet name="footer">
                        <a:outputPanel rendered="#{not empty personList.resultList}">
                            <ui:include src="/layout/pageA4jNavigation.xhtml">
                                <ui:param name="entityList" value="#{inventoryList}"/>
                                <ui:param name="render" value="inventoryResult"/>
                            </ui:include>
                        </a:outputPanel>
                    </f:facet>
                </rich:dataTable>
            </a:region>
        </a:outputPanel>

    </rich:collapsiblePanel>
</h:form>
<h:form id="storeOutItems">
    <rich:dataTable style="width: 100%" rendered="#{(not empty storeOutAction.selectStore)}" value="#{storeOutItems}"
                    var="_item">
        <f:facet name="header">
            <rich:columnGroup>
                <rich:column>
                    #{messages.res}
                </rich:column>
                <rich:column>
                    #{messages.StoreArea}
                </rich:column>
                <rich:column>
                    #{messages.InventoryCount}
                </rich:column>
                <rich:column>
                    #{messages.storeOutCount}
                </rich:column>
                <rich:column>
                    #{messages.action}
                </rich:column>
            </rich:columnGroup>
        </f:facet>

        <rich:column>

            #{_item.stock.storeRes.res.name}(#{_item.stock.storeRes.res.code}) #{' '}
            <a:repeat value="#{_item.stock.storeRes.formatList}" var="_format">
                #{' '}
                #{_format.formatDefine.name} :
                <h:outputText value="#{dictionary.getWordValue(_format.formatValue)}"
                              rendered="#{_format.formatDefine.dataType.name() eq 'WORD'}"/>
                <h:outputText value="#{_format.formatValue}"
                              rendered="#{not (_format.formatDefine.dataType.name() eq 'WORD')}"/>

            </a:repeat>
        </rich:column>
        <rich:column>
            #{_item.stock.storeArea.getTitle(false)}
        </rich:column>
        <rich:column>
            #{_item.stock.count}
        </rich:column>
        <rich:column>
            <a:region>
                <rich:inputNumberSpinner value="#{_item.count}" enableManualInput="true" minValue="0"
                                         maxValue="#{_item.stock.count}">
                    <a:ajax event="blur" execute="@this" immediate="false"/>
                </rich:inputNumberSpinner>
            </a:region>
        </rich:column>
        <rich:column>
            <a:commandButton render="storeOutItems,inventoryResult" action="#{storeOutAction.removeItem}"
                             title="#{messages.remove}"
                             immediate="true" image="/img/delete.png" execute="@this">
                <a:attachQueue requestDelay="0"/>
            </a:commandButton>
        </rich:column>

    </rich:dataTable>
</h:form>

</ui:define>

</ui:composition>