<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">

    <ui:param name="functionTitle" value="#{allocationStoreOutTask.taskName}"/>

    <ui:define name="toolbar">

        <rich:toolbar>
            <rich:toolbarGroup location="right">
                <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                          view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>

                <s:button styleClass="toolBarBtn" value="#{messages.CancelAllocation}"
                          action="#{allocationStoreOutTask.complete}">
                    <f:param name="cancelAllocation" value="#{true}"/>
                </s:button>

                <s:button styleClass="toolBarBtn" value="#{messages.complete}"
                          action="#{allocationStoreOutTask.complete}">
                    <f:param name="cancelAllocation" value="#{false}"/>
                </s:button>

            </rich:toolbarGroup>
        </rich:toolbar>

    </ui:define>

    <ui:define name="body">
        <rich:panel>
            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.Allocation_field_createDate}
                </ui:define>
                <h:outputText value="#{allocationHome.instance.createDate}">
                    <s:convertDateTime pattern="#{messages.displayDatePattern}"/>
                </h:outputText>

            </s:decorate>

            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.Allocation_applyEmp}
                </ui:define>
                #{dictionary.getEmpNameById(allocationHome.instance.applyEmp)}
            </s:decorate>

            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.Allocation_field_reason}
                </ui:define>
                #{dictionary.getWordValue(allocationHome.instance.reason)}
            </s:decorate>

            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.Allocation_field_outStore}
                </ui:define>
                #{allocationHome.instance.outStore.name}
            </s:decorate>

            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.Allocation_field_inStore}
                </ui:define>
                #{allocationHome.instance.inStore.name}
            </s:decorate>

            <s:decorate template="/layout/seam-display.xhtml">
                <ui:define name="label">
                    #{messages.field_memo}
                </ui:define>
                #{allocationHome.instance.memo}
            </s:decorate>

            <div style="clear: both"/>
        </rich:panel>

        <br/>
        <h:form>
            <rich:dataTable id="outItemsTable" value="#{allocationStoreOutItems}" var="_item" style="width: 100%">
                <f:facet name="header">
                    <rich:columnGroup>
                        <rich:column rowspan="2">
                            #{messages.StoreRes}
                        </rich:column>
                        <rich:column colspan="2">
                            #{messages.allocationApplyCount}
                        </rich:column>
                        <rich:column colspan="2">
                            #{messages.InventoryCount}
                        </rich:column>
                        <rich:column colspan="2">
                            #{messages.storeOutCount}
                        </rich:column>
                        <rich:column rowspan="2">

                        </rich:column>

                        <rich:column breakRowBefore="true">
                            #{messages.MasterUnitCount}
                        </rich:column>
                        <rich:column>
                            #{messages.AuxUnitCount}
                        </rich:column>

                        <rich:column>
                            #{messages.MasterUnitCount}
                        </rich:column>
                        <rich:column>
                            #{messages.AuxUnitCount}
                        </rich:column>

                        <rich:column>
                            #{messages.Res_Unit}
                        </rich:column>
                        <rich:column>
                            #{messages.count}
                        </rich:column>

                    </rich:columnGroup>
                </f:facet>

                <rich:column>
                    <ui:include src="/layout/erp/StoreResTitle.xhtml">
                        <ui:param name="storeRes" value="#{_item.allocationRes.storeRes}"/>
                    </ui:include>

                    <h:graphicImage style="float:right" alt="#{messages.order_item_full}"
                                    title="#{messages.order_item_full}:#{_item.stock.displayMasterCount}(#{_item.stock.displayAuxCount}) "
                                    value="/img/full_tip.png"
                                    rendered="#{_item.enough}"/>

                    <a:outputPanel style="float:right" rendered="#{not _item.enough}">
                        <h:outputText style="color: #FF0000;" value="(#{_item.disparity.displayMasterCount})"/>
                        <h:graphicImage alt="#{messages.order_item_not_full}"
                                        value="/img/not_full_tip.png"/>
                        <rich:tooltip followMouse="false" showDelay="1000" styleClass="tooltip-custom-body"
                                      layout="block">

                                  <span style="white-space: nowrap;color: #FF0000;">
                                    #{messages.order_item_not_full}
                                </span> <br/>

                            <span style="white-space: nowrap;">
                           #{messages.InventoryCount}:
                                #{_item.stock.displayMasterCount}
                                (#{_item.stock.displayAuxCount})  </span> <br/>
                        <span style="white-space: nowrap;color: #FF0000;">
                                #{messages.stockDisparity}:
                            #{_item.disparity.displayMasterCount}
                            (#{_item.disparity.displayAuxCount})
                               </span>
                        </rich:tooltip>
                    </a:outputPanel>
                </rich:column>

                <rich:column>
                    #{_item.allocationRes.displayMasterCount}
                </rich:column>

                <rich:column>
                    #{_item.allocationRes.displayAuxCount}
                </rich:column>

                <rich:column>
                    <h:outputText value="#{_item.stock.displayMasterCount}"
                                  rendered="#{not empty _item.stock}"/>
                </rich:column>

                <rich:column>
                    <h:outputText value="#{_item.stock.displayAuxCount}"
                                  rendered="#{not empty _item.stock}"/>
                </rich:column>

                <rich:column>
                    <s:decorate rendered="#{not empty _item.stockChangeItem}" template="/layout/grid-inside-edit.xhtml" >
                        <rich:inplaceSelect value="#{_item.stockChangeItem.useUnit}"
                                            label="#{messages.Res_Unit}"
                                            required="true" style="width: 90%">
                            <s:selectItems value="#{_item.allocationRes.storeRes.res.unitGroup.resUnitList}"
                                           var="_unit" label="#{_unit.name}"/>
                            <f:converter converterId="erpEntityConverter"/>
                            <a:ajax event="selectitem" render="outItemsTable"/>
                        </rich:inplaceSelect>
                    </s:decorate>
                </rich:column>

                <rich:column>
                    <s:decorate rendered="#{not empty _item.stockChangeItem}" template="/layout/grid-inside-edit.xhtml">
                        <rich:inplaceInput value="#{_item.stockChangeItem.useUnitCount}"
                                           converter="javax.faces.BigDecimal" style="width: 90%"
                                           required="true" label="#{messages.count}">
                             <f:validateDoubleRange minimum="0"
                                                    maximum="#{_item.stock.getCountByResUnit(_item.stockChangeItem.useUnit)}"/>
                            <a:ajax event="blur" render="outItemsTable"/>
                        </rich:inplaceInput>
                    </s:decorate>
                </rich:column>

                <rich:column>

                </rich:column>

            </rich:dataTable>
        </h:form>
    </ui:define>

</ui:composition>