<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">

<ui:param name="functionTitle" value="#{messages.Inventory}"/>

<ui:define name="func-body">

<h:outputStylesheet>
    .barsearch {
        height: 14px;
        width: 100px;
    }
</h:outputStylesheet>


<s:decorate template="/layout/edit-modalpanel.xhtml">
<ui:param name="panelId" value="changeInputPanel"/>
<ui:param name="panelTitle" value="#{messages.InventoryEndCount}"/>

<ui:define name="controls">
    <a:commandButton immediate="true"
                     execute="@this" image="/img/close.png"
                     onclick="#{rich:component(panelId)}.hide(); return false;"/>
</ui:define>
<a:outputPanel rendered="#{not empty inventoryItems.editingItem}">


<ui:include src="/layout/erp/StoreResTitle.xhtml">
    <ui:param name="storeRes" value="#{inventoryItems.editingItem.storeRes}"/>
</ui:include>

<div style="clear: both"/>
<br/>

<table class="detailsTable">
<tr>
    <th colspan="2"></th>
    <th style="min-width: 80px">#{messages.MasterUnitCount}</th>
    <th style="min-width: 80px">#{messages.AuxUnitCount}</th>
</tr>
<tr>
    <th colspan="2">#{messages.SeasonBiginCount}</th>
    <td><h:outputText value="#{inventoryItems.editingItem.beginCount.masterCount}">
        <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
    </h:outputText>
        <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>


    </td>
    <td>
        <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
            <h:outputText value="#{inventoryItems.editingItem.beginCount.auxCount}">
                <f:convertNumber
                        pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
            </h:outputText>

            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                          style="float: right"/>
        </a:outputPanel>
    </td>

</tr>
<c:forEach items="#{inventoryItems.editingItem.storeInTypeCounts}" var="_countEntry">

    <tr>
        <c:if test="#{_countEntry.key eq inventoryItems.editingItem.firstInType}">
            <th style="width: 1px;"
                rowspan="#{inventoryItems.editingItem.storeInTypeCounts.size + 1}">#{messages.storeIn}</th>
        </c:if>
        <th>
            #{messages[_countEntry.key.name()]}
        </th>
        <td>

            <h:outputText value="#{_countEntry.value.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{_countEntry.value.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>

    </tr>

</c:forEach>

<c:if test="#{not empty inventoryItems.editingItem.firstInType}">
    <tr>
        <th>
            #{messages.GroupTotal}
        </th>
        <td>

            <h:outputText value="#{inventoryItems.editingItem.inCount.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{inventoryItems.editingItem.inCount.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>
    </tr>
</c:if>


<c:forEach items="#{inventoryItems.editingItem.storeOutTypeCounts}" var="_outEntry">
    <tr>
        <c:if test="#{inventoryItems.editingItem.firstOutType eq _outEntry.key}">
            <th style="width: 1px;"
                rowspan="#{inventoryItems.editingItem.storeOutTypeCounts.size + inventoryItems.editingItem.allocationOutCounts.size + 1}">
                #{messages.StoreOut}
            </th>
        </c:if>

        <th>#{messages[_outEntry.key.name()]}</th>
        <td>

            <h:outputText value="#{_outEntry.value.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{_outEntry.value.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>
    </tr>
</c:forEach>

<c:forEach items="#{inventoryItems.editingItem.allocationOutCounts}" var="_allocation">
    <tr>
        <c:if test="#{(empty inventoryItems.editingItem.firstOutType) and inventoryItems.editingItem.isFirstStore(_allocation.key.id)}">
            <th style="width: 1px;" rowspan="#{inventoryItems.editingItem.allocationOutCounts.size + 1}">
                #{messages.StoreOut}
            </th>
        </c:if>

        <th>
            #{messages.AllocationTo} #{_allocation.key.name}
        </th>

        <td>

            <h:outputText value="#{_allocation.value.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{_allocation.value.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>
    </tr>
</c:forEach>

<c:if test="#{(not empty inventoryItems.editingItem.firstOutType) or (not empty inventoryItems.editingItem.firstInType)}">
    <tr>
        <th>#{messages.GroupTotal}</th>
        <td>

            <h:outputText value="#{inventoryItems.editingItem.outCount.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{inventoryItems.editingItem.outCount.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>
    </tr>
</c:if>

<tr>
    <th colspan="2">#{messages.InventoryLastCount}</th>
    <td>

        <h:outputText value="#{inventoryItems.editingItem.lastCount.masterCount}">
            <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
        </h:outputText>
        <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
    </td>
    <td>
        <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
            <h:outputText value="#{inventoryItems.editingItem.lastCount.auxCount}">
                <f:convertNumber
                        pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
            </h:outputText>

            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                          style="float: right"/>
        </a:outputPanel>
    </td>
</tr>
<c:if test="#{not (inventoryItems.editingItem.inventoryItem.changeType eq 'NO_CHANGE')}">
    <tr>
        <th colspan="2">#{messages[inventoryItems.editingItem.inventoryItem.changeType.name()]}</th>
        <td>

            <h:outputText value="#{inventoryItems.editingItem.diffCount.masterCount}">
                <f:convertNumber pattern="#{inventoryItems.editingItem.res.unitGroup.masterUnit.countFormate}"/>
            </h:outputText>
            <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.masterUnit.name}" style="float: right"/>
        </td>
        <td>
            <a:outputPanel rendered="#{(inventoryItems.editingItem.res.unitGroup.type eq 'FLOAT_CONVERT')}">
                <h:outputText value="#{inventoryItems.editingItem.diffCount.auxCount}">
                    <f:convertNumber
                            pattern="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.countFormate}"/>
                </h:outputText>

                <h:outputText value="#{inventoryItems.editingItem.res.unitGroup.floatAuxiliaryUnit.name}"
                              style="float: right"/>
            </a:outputPanel>
        </td>
    </tr>
</c:if>

</table>
<div style="clear: both"/>
<br/>
<s:decorate rendered="#{inventoryItems.newStoreRes}" template="/layout/edit.xhtml">
    <ui:define name="label">
        #{messages.storeRes_field_code}
    </ui:define>
    <h:inputText value="#{inventoryItems.editingItem.storeRes.code}" required="true"
                 label="#{messages.storeRes_field_code}"/>
</s:decorate>


<ui:include src="/layout/erp/res/StoreResCountInput.xhtml">
    <ui:param name="inputValue" value="#{inventoryItems.editingItem}"/>
    <ui:param name="formatTemplate" value="/layout/edit.xhtml"/>
    <ui:param name="countLableStyleClass" value="small_name"/>
    <ui:param name="showTitle" value="false"/>
    <ui:param name="label" value="#{messages.InventoryEndCount}"/>
</ui:include>
</a:outputPanel>

<ui:define name="actionButtons">
    <a:commandButton value="#{messages.cancel}" onclick="#{rich:component('changeInputPanel')}.hide();return false;"/>

    <a:commandButton execute="@form" action="#{inventoryItems.saveChange}"
                     rendered="#{not empty inventoryItems.editingItem}"
                     data="#{inventoryItems.saveStatus}" value="#{messages.ok}"
                     oncomplete="if (event.data == 'CODE_VALID')#{rich:component('changeInputPanel')}.hide();"
                     render="changeInputPanel_form,resultDatas">
        <a:attachQueue requestDelay="0"/>
    </a:commandButton>
</ui:define>

</s:decorate>

<rich:toolbar>
    <rich:toolbarGroup>
        <h:form>
            <h:panelGrid id="resSearchForm" columns="4">
                <h:inputText styleClass="barsearch" id="resItemCode" value="#{resCode.code}"
                             required="true">
                    <rich:placeholder value="#{messages.res_field_code}"/>
                </h:inputText>

                <a:commandButton styleClass="toolBarBtn" value="#{messages.search}" execute="@form"
                                 data="#{resCode.codeStatus}"
                                 oncomplete="if (event.data == 'STORERES_DEFINED')#{rich:component('changeInputPanel')}.show();"
                                 render="changeInputPanel_form"
                                 action="#{inventoryItems.beginChangeByCode}">
                    <a:attachQueue requestDelay="0"/>
                </a:commandButton>

            </h:panelGrid>
        </h:form>
    </rich:toolbarGroup>

    <rich:toolbarGroup location="right">


        <h:panelGroup>
            <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                      view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>

            <s:button styleClass="toolBarBtn" value="#{messages.abortInventory}"
                      action="#{inventoryFirst.complete}">
                <f:param name="abort" value="#{true}"/>
            </s:button>

            <s:button styleClass="toolBarBtn" value="#{messages.complete}"
                      action="#{inventoryFirst.complete}">
                <f:param name="abort" value="#{false}"/>
            </s:button>

        </h:panelGroup>
    </rich:toolbarGroup>
</rich:toolbar>
<br/>
<rich:messages ajaxRendered="true" globalOnly="true"/>
<br/>

<h:form id="conditionsForm">
    <ui:include src="/layout/erp/res/StoreResCondition.xhtml"/>

    <div style="clear: both;"/>

    <hr style="border:1px dashed #{a4jSkin.panelBorderColor}" width="95%" size="1"/>
    <h:panelGrid columns="1" style="width: 100%; text-align: right">
        <a:outputPanel>
            <div class="actionButtons">


                <a:outputPanel id="searchButton">
                    <a:commandButton value="#{messages.reset}" execute="@this" immediate="true"
                                     action="#{storeResCondition.reset}"
                                     render="resultDatas,conditionsForm">
                        <a:attachQueue requestDelay="0"/>
                    </a:commandButton>
                    <a:commandButton value="#{messages.InventoryEndCount}" action="#{inventoryItems.beginChange}"
                                     execute="@form" render="changeInputPanel_form"
                                     oncomplete="#{rich:component('changeInputPanel')}.show();">
                        <a:attachQueue requestDelay="0"/>
                    </a:commandButton>

                    <a:commandButton value="#{messages.Filter}"
                                     execute="@form" render="resultDatas">
                        <a:attachQueue requestDelay="0"/>
                    </a:commandButton>
                </a:outputPanel>
            </div>
        </a:outputPanel>
    </h:panelGrid>

</h:form>


<h:form>
    <div style="width: 100%;height: 700px; overflow-x: auto; overflow-y: auto; padding: 0; margin: 0">

        <a:outputPanel id="resultDatas">

            <s:decorate template="/layout/erp/InventoryDataTable.xhtml">
                <ui:define name="formatTitleColumn">
                    <h:outputText value="#{_formatGroup.key.formatTitle}"
                                  rendered="#{_formatGroup.key.res.unitGroup.type eq 'FLOAT_CONVERT'}"/>
                    <a:commandLink value="#{_formatGroup.key.formatTitle}"
                                   rendered="#{not (_formatGroup.key.res.unitGroup.type eq 'FLOAT_CONVERT')}"
                                   action="#{inventoryItems.beginChangeByItem}" execute="@this"
                                   render="changeInputPanel_form"
                                   immediate="true" oncomplete="#{rich:component('changeInputPanel')}.show();">

                        <a:attachQueue requestDelay="0"/>
                        <a:param value="#{_formatGroup.totalData.firstData.inventoryItem.id}"
                                 assignTo="#{inventoryItems.editingItemId}"/>

                    </a:commandLink>


                </ui:define>
                <ui:define name="itemTitleComumn">
                    <a:commandLink action="#{inventoryItems.beginChangeByItem}" execute="@this"
                                   render="changeInputPanel_form"
                                   immediate="true" oncomplete="#{rich:component('changeInputPanel')}.show();">
                        <h:outputText value="#{_item.storeRes.floatConversionRate}">
                            <f:convertNumber pattern="#{_item.res.unitGroup.floatConvertRateFormat}"/>
                        </h:outputText>
                        <h:outputText value="#{_item.res.unitGroup.name}"/>
                        <a:attachQueue requestDelay="0"/>
                        <a:param value="#{_item.inventoryItem.id}" assignTo="#{inventoryItems.editingItemId}"/>
                    </a:commandLink>
                </ui:define>
            </s:decorate>

        </a:outputPanel>
    </div>
</h:form>
<br/>

<rich:panel>
    <ui:include src="/layout/erp/InventoryMainDetails.xhtml">

        <ui:param name="inventory" value="#{inventoryHome.instance}"/>
    </ui:include>

    <div style="clear: both"/>
</rich:panel>

</ui:define>

</ui:composition>