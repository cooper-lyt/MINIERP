<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">

<ui:param name="functionTitle" value="#{messages.orderDispatch}"/>

<ui:define name="func-body">

<h:outputStylesheet>
    .leftColumn {
        vertical-align: top;
        width: 50%;
    }

    .rightColumn {
        width: 50%;
        vertical-align: top;
    }
</h:outputStylesheet>

<rich:toolbar height="34" itemSeparator="line">

    <rich:toolbarGroup location="right" id="orderDispatchTaskAction">
        <h:panelGroup>
            <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                      view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>
            <s:button styleClass="toolBarBtn" value="#{messages.complete}"
                      onclick="if(#{not empty orderDispatch.storeResOrderItems}) {alert('#{messages.orderDispatchCantComplete}');return false;}"
                      action="#{orderDispatch.complete}"/>
        </h:panelGroup>
    </rich:toolbarGroup>
</rich:toolbar>

<rich:messages ajaxRendered="true" globalOnly="true"/>

<!--tencent://message/?uin=2751194453&amp;Site=blog.sina.com&amp;Menu=yes-->


<s:decorate template="/layout/edit-modalpanel.xhtml">
    <ui:param name="panelId" value="dispatchEditPanel"/>
    <ui:param name="panelTitle" value="#{messages.Dispatch}"/>
    <ui:define name="controls">

    </ui:define>

    <s:decorate id="dispatchEditPanelDeliveryTypeField" template="/layout/edit.xhtml">
        <ui:define name="label">#{messages.order_field_deliveryType}</ui:define>
        <h:selectOneMenu value="#{orderDispatch.selectDispatch.deliveryType}"
                         required="true" label="#{messages.order_field_deliveryType}">
            <s:selectItems value="#{deliveryTypes}" var="_type"
                           label="#{messages[_type.name()]}"
                           noSelectionLabel="#{messages.noSelectLabel}"/>
            <s:convertEnum/>
            <a:ajax event="valueChange" render="dispatchEditPanelFarePayTypeField,dispatchEditPanelDeliveryTypeField">
                <a:attachQueue requestDelay="0"/>
            </a:ajax>
        </h:selectOneMenu>
    </s:decorate>

    <a:outputPanel id="dispatchEditPanelFarePayTypeField">
        <s:decorate
                rendered="#{ (not empty orderDispatch.selectDispatch.deliveryType) and orderDispatch.selectDispatch.deliveryType.haveFare}"
                template="/layout/edit.xhtml">
            <ui:define name="label">#{messages.order_field_farePayType}</ui:define>
            <h:selectOneMenu value="#{orderDispatch.selectDispatch.farePayType}"
                             required="true" label="#{messages.order_field_farePayType}">
                <s:selectItems value="#{farePayTypes}" var="_type"
                               label="#{messages[_type.name()]}"
                               noSelectionLabel="#{messages.noSelectLabel}"/>
                <s:convertEnum/>
            </h:selectOneMenu>
        </s:decorate>
    </a:outputPanel>

    <ui:define name="actionButtons">
        <a:commandButton immediate="true"
                         execute="@this" value="#{messages.ok}"
                         data="#{actionExecuteState.lastState}"
                         action="#{actionExecuteState.actionExecute}"
                         render="dispatchItems"
                         oncomplete="if (event.data == 'success')#{rich:component(panelId)}.hide();">
            <a:attachQueue requestDelay="0"/>

        </a:commandButton>
    </ui:define>
</s:decorate>

<s:decorate template="/layout/edit-modalpanel.xhtml">
    <ui:param name="panelId" value="singleDispatchPanel"/>
    <ui:param name="panelTitle" value="#{messages.Dispatch}"/>
    <ui:define name="controls">
        <a:commandButton immediate="true"
                         execute="@this" image="/img/close.png"
                         onclick="#{rich:component(panelId)}.hide(); return false;">
        </a:commandButton>
    </ui:define>
    <s:decorate template="/layout/edit.xhtml">
        <ui:define name="label">#{messages.dispatch_field_store}</ui:define>
        <h:selectOneMenu value="#{orderDispatch.store}"
                         required="true" label="#{messages.dispatch_field_store}">
            <s:selectItems value="#{storeList.resultList}" var="_store"
                           label="#{_store.name}(#{_store.id})" noSelectionLabel="#{messages.noSelectLabel}"/>
            <a:ajax event="valueChange" render="newDispatchFields"
                    listener="#{orderDispatch.storeSelectListener}"/>
            <f:converter converterId="erpEntityConverter"/>
        </h:selectOneMenu>
    </s:decorate>

    <a:outputPanel rendered="#{not empty orderDispatch.selectOrderItem}">
        <ui:include src="/layout/erp/ResCountInput.xhtml">
            <ui:param name="resCountBean" value="#{orderDispatch.storeResCountInupt}"/>
        </ui:include>
    </a:outputPanel>
    <a:outputPanel id="newDispatchFields">

        <a:outputPanel rendered="#{(not empty orderDispatch.store) and (not orderDispatch.dispatchStoreExists)}">
            <s:decorate id="deliveryTypeField" template="/layout/edit.xhtml">
                <ui:define name="label">#{messages.order_field_deliveryType}</ui:define>
                <h:selectOneMenu value="#{orderDispatch.deliveryType}"
                                 required="true" label="#{messages.order_field_deliveryType}">
                    <s:selectItems value="#{deliveryTypes}" var="_type"
                                   label="#{messages[_type.name()]}"
                                   noSelectionLabel="#{messages.noSelectLabel}"/>
                    <s:convertEnum/>
                    <a:ajax event="valueChange" render="deliveryTypeField,farePayTypeField">
                        <a:attachQueue requestDelay="0"/>
                    </a:ajax>
                </h:selectOneMenu>
            </s:decorate>

            <a:outputPanel id="farePayTypeField">
                <s:decorate
                        rendered="#{ (not empty orderDispatch.deliveryType) and orderDispatch.deliveryType.haveFare}"
                        template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.order_field_farePayType}</ui:define>
                    <h:selectOneMenu value="#{orderDispatch.farePayType}"
                                     required="true" label="#{messages.order_field_farePayType}">
                        <s:selectItems value="#{farePayTypes}" var="_type"
                                       label="#{messages[_type.name()]}"
                                       noSelectionLabel="#{messages.noSelectLabel}"/>
                        <s:convertEnum/>
                    </h:selectOneMenu>
                </s:decorate>
            </a:outputPanel>

            <s:decorate template="/layout/edit.xhtml">
                <ui:define name="label">#{messages.field_memo}</ui:define>
                <h:inputTextarea value="#{orderDispatch.memo}"
                                 label="#{messages.field_memo}" cols="27" rows="2"/>
            </s:decorate>
        </a:outputPanel>
    </a:outputPanel>

    <ui:define name="actionButtons">
        <a:commandButton immediate="true"
                         execute="@this" value="#{messages.cancel}"
                         onclick="#{rich:component(panelId)}.hide(); return false;">
        </a:commandButton>

        <a:commandButton value="#{messages.ok}" execute="@form"
                         data="#{actionExecuteState.lastState}"
                         oncomplete="if (event.data == 'success')#{rich:component(panelId)}.hide();"
                         render="singleDispatchPanel_inputs,orderDispatchTaskAction,orderStoreResOrderItems,dispatchItems"
                         action="#{orderDispatch.dispatchAllStoreRes}">
            <a:attachQueue requestDelay="0"/>
        </a:commandButton>


    </ui:define>
</s:decorate>

<h:panelGrid style="width:100%" columns="2" columnClasses="leftColumn,rightColumn">
    <h:form>
        <rich:dataTable style="width: 100%" id="orderStoreResOrderItems" value="#{orderDispatch.storeResOrderItems}"
                        var="_orderItem"
                        noDataLabel="#{messages.emptyResult}">
            <f:facet name="header">
                <rich:columnGroup>
                    <rich:column colspan="3">
                        <h:outputText value="#{messages.order_storeRes_item}"/>

                        <rich:column>
                            <a:commandButton style="float: right" value="#{messages.dispatch_all}" execute="@this"
                                             immediate="true" render="singleDispatchPanel_inputs"
                                             rendered="#{not empty orderDispatch.storeResOrderItems}"
                                             action="#{orderDispatch.beginDispatchAll}"
                                             oncomplete="#{rich:component('singleDispatchPanel')}.show();return false;">
                                <a:attachQueue requestDelay="0"/>
                            </a:commandButton>
                        </rich:column>
                    </rich:column>


                    <rich:column breakRowBefore="true">
                        <h:outputText value="#{messages.Store}"/>
                    </rich:column>
                    <rich:column>
                        <h:outputText value="#{messages.stockCount}"/>
                    </rich:column>
                    <rich:column>
                        <h:outputText value="#{messages.AuxUnitCount}"/>
                    </rich:column>


                </rich:columnGroup>
            </f:facet>
            <rich:column colspan="4">
                <rich:collapsibleSubTableToggler for="srsbtbl"/>
                <ui:include src="/layout/erp/StoreResTitle.xhtml">
                    <ui:param name="storeRes" value="#{_orderItem.storeRes}"/>
                </ui:include>
                [ #{messages.order_storeRes_count}: <b>#{_orderItem.storeResCount.masterDisplayCount}</b>
                #{' '} #{_orderItem.storeResCount.displayAuxCount}]

                <a:commandButton style="float: right" value="#{messages.dispatch_item}" execute="@this"
                                 immediate="true" render="singleDispatchPanel_inputs"
                                 rendered="#{not empty orderDispatch.storeResOrderItems}"
                                 action="#{orderDispatch.beginDispatchItem}"
                                 oncomplete="#{rich:component('singleDispatchPanel')}.show();return false;">
                    <a:param value="#{_orderItem.id}" assignTo="#{orderDispatch.orderItemId}"/>
                    <a:attachQueue requestDelay="0"/>
                </a:commandButton>

            </rich:column>


            <rich:collapsibleSubTable value="#{_orderItem.storeRes.vaildStockList}"
                                      var="_item" id="srsbtbl" expandMode="client">
                <rich:column>
                    <h:outputText value="#{_item.store.name}(#{_item.store.id})"/>
                </rich:column>
                <rich:column>
                    <h:outputText value="#{_item.resCount.masterDisplayCount}"/>
                </rich:column>
                <rich:column>
                    #{_item.resCount.displayAuxCount}
                </rich:column>

                <f:facet name="footer">
                    <h:outputText
                            value="#{messages.recordTotal} #{_orderItem.storeRes.vaildStockList.size} #{messages.total_in_store} [#{messages.total_count} #{_orderItem.storeRes.totalCount.masterDisplayCount} #{_orderItem.storeRes.totalCount.displayAuxCount}]"/>
                </f:facet>
            </rich:collapsibleSubTable>


        </rich:dataTable>
    </h:form>


    <h:form id="dispatchItems">
        <rich:dataTable style="width: 100%" value="#{orderDispatch.dispatchList}" var="_dispatch"
                        noDataLabel="#{messages.emptyResult}">
            <f:facet name="header">
                <rich:columnGroup>
                    <rich:column colspan="4">
                        #{messages.Dispatch}

                        <s:button style="float: right" value="#{messages.reset}" includePageParams="true"/>
                        <s:div style="float: left">
                            <a target="_blank"
                               href="http://wpa.qq.com/msgrd?v=3&amp;uin=2751194453&amp;site=qq&amp;menu=yes">
                                <img border="0" src="http://wpa.qq.com/pa?p=1:271569542:1" alt="点击这里给我发消息"
                                     title="点击这里给我发消息"/></a>
                        </s:div>
                    </rich:column>
                    <rich:column breakRowBefore="true">
                        #{messages.StoreRes}
                    </rich:column>
                    <rich:column>
                        #{messages.stockOutCount}
                    </rich:column>
                    <rich:column>
                        <h:outputText value="#{messages.AuxUnitCount}"/>
                    </rich:column>
                    <rich:column>

                    </rich:column>
                </rich:columnGroup>
            </f:facet>

            <rich:column colspan="4">
                <rich:collapsibleSubTableToggler for="sbtblDispatchItem"/>
                #{_dispatch.store.name}(#{_dispatch.store.id})

                [
                #{messages.order_field_deliveryType}:#{messages[_dispatch.deliveryType.name()]}
                <h:outputText value="#{messages.order_field_farePayType}:#{messages[_dispatch.farePayType.name()]}"
                              rendered="#{_dispatch.deliveryType.haveFare}"/>
                <a:commandButton image="/img/edit.png" immediate="true" render="dispatchEditPanel_inputs"
                                 action="#{orderDispatch.beginEditDispatchInfo}"
                                 oncomplete="#{rich:component('dispatchEditPanel')}.show();return false;">

                    <a:param value="#{_dispatch.store.id}" assignTo="#{orderDispatch.storeId}"/>
                    <a:attachQueue requestDelay="0"/>
                </a:commandButton>
                ]
            </rich:column>

            <rich:collapsibleSubTable id="sbtblDispatchItem" value="#{_dispatch.dispatchItemList}"
                                      var="_dispatchItem">
                <rich:column>
                    <ui:include src="/layout/erp/StoreResTitle.xhtml">
                        <ui:param name="storeRes" value="#{_dispatchItem.storeRes}"/>
                    </ui:include>

                </rich:column>
                <rich:column>
                    #{_dispatchItem.resCount.masterDisplayCount}
                </rich:column>
                <rich:column>
                    #{_dispatchItem.resCount.displayAuxCount}
                </rich:column>
                <rich:column>

                </rich:column>
            </rich:collapsibleSubTable>
        </rich:dataTable>
    </h:form>
</h:panelGrid>

<br/>

<rich:collapsiblePanel switchType="client" expanded="false" header="#{messages.order_info}">
    <s:decorate template="/layout/erp/publicOrderInfo.xhtml">

    </s:decorate>
</rich:collapsiblePanel>


</ui:define>
</ui:composition>