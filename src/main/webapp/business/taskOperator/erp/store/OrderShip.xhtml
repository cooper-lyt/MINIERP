<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">

<ui:param name="functionTitle" value="#{messages.orderShip}"/>

<ui:define name="func-body">

<h:outputStylesheet>
    .overlyColumn {
        vertical-align: top;
        width: 50%;
    }

</h:outputStylesheet>

<s:decorate template="/layout/edit-modalpanel.xhtml">
    <ui:param name="panelId" value="overlyPriceInputPanel"/>
    <ui:param name="panelTitle" value="#{messages.orderItemPrice}"/>

    <ui:define name="controls">
        <a:commandButton immediate="true"
                         execute="@this" image="/img/close.png"
                         onclick="#{rich:component(panelId)}.hide(); return false;">

            <a:attachQueue requestDelay="0"/>
        </a:commandButton>
    </ui:define>

    <ui:include src="/layout/erp/StoreResTitle.xhtml">
        <ui:param name="storeRes" value="#{orderShip.editingOrderItem.storeRes}"/>
    </ui:include>

    <s:decorate template="/layout/display.xhtml">
        <ui:define name="label">#{messages.orderItemCount}</ui:define>
        #{orderShip.selectOverly.resCount.masterDisplayCount}(#{orderShip.selectOverly.resCount.displayAuxCount})
    </s:decorate>

    <div style="clear:both"/>
    <a:outputPanel id="priceFields">

        <div>
            <s:label styleClass="small_name">
                #{messages.orderItemPrice}
                <s:span styleClass="required">*</s:span>
            </s:label>


            <s:span styleClass="value">
                #{messages.orderItemUnitPrice}
                <h:inputText required="true" size="12" label="#{messages.orderItemUnitPrice}"
                             value="#{orderShip.editingOrderItem.money}">
                    <f:convertNumber groupingUsed="false" type="currency" locale="#{calendarBean.locale}"
                                     currencySymbol=""/>
                    <a:ajax event="blur" render="priceFields"
                            listener="#{orderShip.calcPriceByUnitMoney}">
                        <a:attachQueue requestDelay="0"/>
                    </a:ajax>
                </h:inputText>
            </s:span>


            <s:span styleClass="value">
                <h:outputText value="#{' / '}"/>

                <h:selectOneMenu value="#{orderShip.editingOrderItem.moneyUnit}" style="width: 80px"
                                 required="true">
                    <s:selectItems value="#{orderShip.editingOrderItem.storeRes.res.unitGroup.resUnitList}" var="_unit"
                                   label="#{_unit.name}"/>
                    <f:converter converterId="erpEntityConverter"/>
                    <a:ajax event="valueChange" listener="#{orderShip.calcPriceByUnit}"
                            render="priceFields">
                        <a:attachQueue requestDelay="0"/>
                    </a:ajax>
                </h:selectOneMenu>
            </s:span>

            <s:span styleClass="value">
                #{messages.orderItemPriceRebate}

                <h:inputText required="true" label="#{messages.rebate}" size="7"
                             value="#{orderShip.editingOrderItem.rebate}">
                    <f:convertNumber pattern="#0.##"/>
                    <a:ajax event="blur" render="priceFields"
                            listener="#{orderShip.calcPriceByRebate}">
                        <a:attachQueue requestDelay="0"/>
                    </a:ajax>
                </h:inputText>
            </s:span>


            <s:span styleClass="value">
                <h:inputText size="17" value="#{orderShip.editingOrderItemTotalMoney}"
                             label="#{messages.orderItemPrice}">
                    <f:convertNumber type="currency" locale="#{calendarBean.locale}" currencySymbol=""
                                     groupingUsed="false"/>
                    <a:ajax event="blur" render="priceFields"
                            listener="#{orderShip.calcPriceByTotalMoney}">
                        <a:attachQueue requestDelay="0"/>
                    </a:ajax>
                </h:inputText>
            </s:span>


        </div>
    </a:outputPanel>

    <ui:define name="actionButtons">
        <a:commandButton value="#{messages.cancel}" immediate="true"
                         onclick="#{rich:component(panelId)}.hide(); return false;"/>
        <a:commandButton value="#{messages.ok}" execute="@form" render="overlyItems,overlyOrderItems,orderTotalPrice"
                         action="#{orderShip.saveOverlyToOrderItem}"
                         data="#{actionExecuteState.lastState}"
                         oncomplete="if (event.data == 'success')#{rich:component('overlyPriceInputPanel')}.hide();">
            <a:attachQueue requestDelay="0"/>
        </a:commandButton>
    </ui:define>

</s:decorate>

<s:decorate template="/layout/edit-modalpanel.xhtml">
    <ui:param name="panelId" value="empSelectPanel"/>
    <ui:param name="panelTitle" value="#{messages.plaseSelectToDoorDriver}"/>
    <ui:define name="controls">
        <a:commandButton immediate="true"
                         execute="@this" image="/img/close.png"
                         onclick="#{rich:component(panelId)}.hide(); return false;">

            <a:attachQueue requestDelay="0"/>
        </a:commandButton>
    </ui:define>


    <ui:define name="formContent">
        <rich:panel style="width: 300px;height: 360px">
            <rich:tree
                    var="_node"
                    value="#{employeeHome.employeeTree}"
                    nodeType="#{_node.type}"
                    onbeforeselectionchange="if (arguments[2].newSelection[0].__canBeToggled()) { arguments[2].newSelection[0].toggle();return false;} "
                    toggleType="client"
                    selectionType="client">
                <rich:treeNode type="org">
                    #{_node.org.name}
                </rich:treeNode>

                <rich:treeNode type="emp">

                    <a:commandLink value="#{_node.emp.person.name}(#{_node.emp.id})" execute="@this"
                                   immediate="true"
                                   render="shipSendEmpField"
                                   oncomplete="#{rich:component('empSelectPanel')}.hide();">
                        <a:param value="#{_node.emp.id}"
                                 assignTo="#{dispatchHome.instance.sendEmp}"/>
                        <a:attachQueue requestDelay="0"/>
                        <s:conversationId/>
                    </a:commandLink>

                </rich:treeNode>
            </rich:tree>
        </rich:panel>
    </ui:define>
</s:decorate>


<h:form>
    <rich:toolbar>
        <rich:toolbarGroup>
            <h:panelGrid columns="2">
                <h:outputText value="#{messages.EXPRESS_PROXY}:"
                              rendered="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') and dispatchHome.instance.needRes.type eq 'ORDER_SEND'}"/>

                <h:outputText value="#{orderStoreOut.shortageMoney}"
                              rendered="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') and dispatchHome.instance.needRes.type eq 'ORDER_SEND'}">
                    <f:convertNumber locale="#{calendarBean.locale}"
                                     type="currency" groupingUsed="true"/>
                </h:outputText>
            </h:panelGrid>

        </rich:toolbarGroup>

        <rich:toolbarGroup location="right">
            <a:region>
                <h:panelGrid id="orderTotalPrice" columns="20">
                    #{messages.orderPrice}:
                    <h:outputText value="#{orderShip.orderResTotalMoney}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                    * #{' '} %
                    <h:inputText id="orderTotalRebateField" value="#{orderShip.orderRebate}"
                                 required="true" size="5" label="#{messages.orderRebate}">
                        <f:convertNumber pattern="#0.##" groupingUsed="false"/>
                        <a:ajax event="blur" execute="@region" listener="#{orderShip.calcByRate}"
                                render="orderTotalPrice">
                            <a:attachQueue requestDelay="0"/>
                        </a:ajax>
                        <rich:validator/>
                        <f:validateDoubleRange minimum="0" maximum="100"/>
                        <rich:placeholder value="#{messages.orderRebate}"/>
                    </h:inputText>
                    <rich:message for="orderTotalRebateField" styleClass="message-icon"
                                  showDetail="true" showSummary="true" tooltip="true"/>
                    =
                    <h:inputText id="orderMoneyField" value="#{orderShip.orderTotalMoney}"
                                 label="#{messages.orderItemPrice}" required="true" size="9">
                        <f:convertNumber locale="#{calendarBean.locale}" currencySymbol=""
                                         type="currency" groupingUsed="false"/>
                        <a:ajax listener="#{orderShip.calcByOrderTotalMoney}" event="blur" execute="@region"
                                render="orderTotalPrice">
                            <a:attachQueue requestDelay="0"/>
                        </a:ajax>
                        <rich:validator/>
                        <rich:placeholder value="#{messages.orderItemPrice}"/>
                    </h:inputText>
                    <rich:message for="orderMoneyField" styleClass="message-icon"
                                  showDetail="true" showSummary="true" tooltip="true"/>
                </h:panelGrid>
            </a:region>
            <h:panelGroup id="orderDispatchTaskAction">
                <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                          view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>
                <h:commandButton styleClass="toolBarBtn" value="#{messages.complete}"
                                 action="#{orderShip.complete}"/>
            </h:panelGroup>
        </rich:toolbarGroup>
    </rich:toolbar>
    <rich:messages ajaxRendered="true" globalOnly="true"/>

    <rich:panel>
        <s:decorate template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.dispatch_field_shipDate}</ui:define>
            <rich:calendar
                    enableManualInput="true"
                    inputSize="20"
                    timeZone="#{calendarBean.timeZone}" locale="#{calendarBean.locale}"
                    showApplyButton="#{calendarBean.showApply}" popup="#{calendarBean.popup}"
                    datePattern="#{messages.datetimepattern}"
                    defaultTime="#{currentTime}"
                    defaultLabel="#{org.jboss.seam.framework.currentDatetime}"
                    required="true"
                    label="#{messages.dispatch_field_shipDate}"
                    value="#{dispatchHome.instance.sendTime}"/>
        </s:decorate>

        <s:decorate template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.dispatch_field_Fare}</ui:define>
            <h:inputText value="#{dispatchHome.instance.fare}" required="true"
                         disabled="#{(not dispatchHome.instance.deliveryType.haveFare) or dispatchHome.instance.needRes.fareByCustomer}"
                         label="#{messages.dispatch_field_Fare}" size="20">
                <f:convertNumber locale="#{calendarBean.locale}" currencySymbol=""
                                 type="currency" groupingUsed="false"/>
            </h:inputText>

        </s:decorate>

        <s:decorate template="/layout/seam-edit.xhtml">
            <ui:define name="label">#{messages.order_dispatch_detail}</ui:define>
            <h:selectBooleanCheckbox value="#{orderShip.inputDetails}">
                <a:ajax event="click" render="shipDetails"/>
            </h:selectBooleanCheckbox>
        </s:decorate>


        <a:outputPanel id="shipDetails">

            <a:outputPanel rendered="#{orderShip.inputDetails}">

                <s:decorate id="shipSendEmpField" template="/layout/seam-edit.xhtml">
                    <ui:define name="label">#{messages.order_field_sendEmployee}</ui:define>


                    <a:commandLink
                            value="#{(empty dispatchHome.instance.sendEmp) ? messages.plaseSelectSendEmp : dictionary.getEmpNameById(dispatchHome.instance.sendEmp)}"
                            immediate="true"
                            onclick="#{rich:component('empSelectPanel')}.show();return false;"/>
                </s:decorate>

                <s:decorate template="/layout/seam-edit.xhtml"
                            rendered="#{dispatchHome.instance.deliveryType eq 'CUSTOMER_SELF'}">
                    <ui:define name="label">#{messages.dispatch_field_outCustomer}</ui:define>
                    <h:inputText value="#{dispatchHome.instance.outCustomer}" maxlength="50" size="27"/>
                </s:decorate>


                <a:outputPanel
                        rendered="#{(dispatchHome.instance.deliveryType eq 'FULL_CAR_SEND') or (dispatchHome.instance.deliveryType eq 'EXPRESS_SEND')}">
                    <ui:include src="/layout/erp/TransCorpInput.xhtml"/>
                </a:outputPanel>

                <a:outputPanel rendered="#{dispatchHome.instance.deliveryType eq 'FULL_CAR_SEND'}">
                    <s:decorate template="/layout/seam-edit.xhtml">
                        <ui:define name="label">#{messages.dispatch_field_expressCarDriver}</ui:define>
                        <h:inputText value="#{dispatchHome.instance.sendDriver}" maxlength="50" size="27"
                                     label="#{messages.dispatch_field_expressCarDriver}"/>
                    </s:decorate>

                    <s:decorate template="/layout/seam-edit.xhtml">
                        <ui:define name="label">#{messages.dispatch_field_expressCarTel}</ui:define>
                        <h:inputText value="#{dispatchHome.instance.sendTel}" maxlength="50" size="27"
                                     label="#{messages.dispatch_field_expressCarTel}"/>
                    </s:decorate>

                    <s:decorate template="/layout/seam-edit.xhtml">
                        <ui:define name="label">#{messages.dispatch_field_expressCarCode}</ui:define>
                        <h:inputText value="#{dispatchHome.instance.sendCarCode}"
                                     maxlength="20"
                                     label="#{messages.dispatch_field_expressCarCode}" size="27"/>
                    </s:decorate>

                </a:outputPanel>


                <s:decorate template="/layout/seam-edit.xhtml"
                            rendered="#{dispatchHome.instance.deliveryType eq 'EXPRESS_SEND'}">
                    <ui:define name="label">#{messages.dispatch_field_expressNumber}</ui:define>
                    <h:inputText value="#{dispatchHome.instance.sendNumber}"
                                 maxlength="100" size="27"/>
                </s:decorate>


                <s:decorate template="/layout/seam-edit.xhtml"
                            rendered="#{dispatchHome.instance.deliveryType eq 'SEND_TO_DOOR'}">
                    <ui:define name="label">#{messages.dispatch_field_expressCarCode}</ui:define>
                    <ui:define name="label">#{messages.Cars}</ui:define>
                    <rich:autocomplete id="carsInputField" mode="client" autofill="true"
                                       required="true"
                                       showButton="true"
                                       selectFirst="true"
                                       label="#{messages.Cars}"
                                       clientFilterFunction="pinyinFilter"
                                       autocompleteList="#{validCarsList.resultList}"
                                       value="#{carsHome.searchId}"
                                       fetchValue="#{_car.id}" var="_car">

                        <h:outputText value="#{_car.id}(#{dictionary.getEmpNameById(_car.defaultDriver)})"/>
                        <a:ajax event="selectitem"
                                render="toDoorInfo" execute="@this">
                            <a:attachQueue requestDelay="0"/>
                        </a:ajax>
                        <a:ajax event="blur" execute="@this"
                                render="toDoorInfo">
                            <a:attachQueue requestDelay="0"/>
                        </a:ajax>
                    </rich:autocomplete>

                </s:decorate>

            </a:outputPanel>
        </a:outputPanel>

        <div style="clear:both">
            <span class="required">*</span>
            #{messages.requiredFields}
        </div>
    </rich:panel>
</h:form>

<br/>

<rich:panel rendered="#{dispatchHome.haveOverlyOut}">

    <f:facet name="header">
        <span class="required">*</span> #{messages.dispathc_overly_confirm}
    </f:facet>

    <h:panelGrid columns="2" style="width: 100%" columnClasses="overlyColumn,overlyColumn">
        <h:form>
            <rich:dataTable style="width: 100%" value="#{orderShip.noConfirmOverlys}" var="_overly" id="overlyItems"
                            noDataLabel="#{messages.dispatch_overly_empty}">

                <f:facet name="header">
                    #{messages.dispatch_overly_items}
                    <a:commandButton image="/img/match_price.png" title="#{messages.autoMatchOverly}"
                                     style="float: right;"
                                     immediate="true"
                                     execute="@this"
                                     action="#{orderShip.autoConfirmAll}"
                                     render="overlyItems,overlyOrderItems,orderTotalPrice">
                        <a:attachQueue requestDelay="0"/>

                    </a:commandButton>

                </f:facet>
                <rich:column>
                    <f:facet name="header">
                        #{messages.StoreRes}
                    </f:facet>
                    <ui:include src="/layout/erp/StoreResTitle.xhtml">
                        <ui:param name="storeRes" value="#{_overly.storeRes}"/>
                    </ui:include>
                    <f:facet name="footer">
                        #{messages.recordTotal}#{orderShip.noConfirmOverlys.size}#{messages.item};
                    </f:facet>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.MasterUnitCount}
                    </f:facet>
                    #{_overly.resCount.masterDisplayCount}
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.AuxUnitCount}
                    </f:facet>
                    #{_overly.resCount.displayAuxCount}

                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.description}
                    </f:facet>
                    #{_overly.description}
                </rich:column>

                <rich:column style="text-align: center;">
                    <f:facet name="header">

                    </f:facet>

                    <a:commandButton image="/img/price.png" immediate="true" execute="@this"
                                     action="#{orderShip.beginConfirmOverly}"
                                     title="#{messages.overlyConfirmPrice}"
                                     render="overlyPriceInputPanel_form"
                                     oncomplete="#{rich:component('overlyPriceInputPanel')}.show();">
                        <a:attachQueue requestDelay="0"/>
                        <a:param value="#{_overly.id}" assignTo="#{orderShip.overlyOutId}"/>
                    </a:commandButton>
                    #{' '}
                    <a:commandButton image="/img/match_price.png" immediate="true" execute="@this"
                                     title="#{messages.autoMatchOverly}"
                                     action="#{orderShip.autoConfirmItem}"
                                     render="overlyItems,overlyOrderItems,orderTotalPrice">
                        <a:attachQueue requestDelay="0"/>
                        <a:param value="#{_overly.id}" assignTo="#{orderShip.overlyOutId}"/>
                    </a:commandButton>


                </rich:column>

            </rich:dataTable>
        </h:form>
        <h:form>
            <rich:dataTable id="overlyOrderItems" style="width: 100%" value="#{overlyOrderItems}" var="_orderItem"
                            noDataLabel="#{messages.dispatch_overly_order_empty}">

                <f:facet name="header">
                    #{messages.confirmOverlyItems}
                    <a:commandButton image="/img/clear_items.png" title="#{messages.resetOverlyPrice}"
                                     style="float: right;"
                                     immediate="true"
                                     execute="@this"
                                     action="#{orderShip.deleteAllOrderItem}"
                                     render="overlyItems,overlyOrderItems,orderTotalPrice">
                        <a:attachQueue requestDelay="0"/>

                    </a:commandButton>
                </f:facet>

                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItem}
                    </f:facet>
                    <ui:include src="/layout/erp/StoreResTitle.xhtml">
                        <ui:param name="storeRes" value="#{_orderItem.storeRes}"/>
                    </ui:include>

                    <f:facet name="footer">
                        #{messages.recordTotal}#{overlyOrderItems.size}#{messages.item};
                    </f:facet>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemCount}
                    </f:facet>

                    <h:outputText value="#{_orderItem.count}">
                        <f:convertNumber pattern="#0.####"/>
                    </h:outputText>


                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.Res_Unit}
                    </f:facet>
                    #{_orderItem.moneyUnit.name}
                </rich:column>

                <rich:column style="text-align: right">
                    <f:facet name="header">
                        #{messages.orderItemUnitPrice}
                    </f:facet>
                    <h:outputText value="#{_orderItem.money}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                </rich:column>


                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemPriceRebate}
                    </f:facet>
                    #{'%'}
                    <h:outputText value="#{_orderItem.rebate}">
                        <f:convertNumber pattern="#0.####"/>
                    </h:outputText>

                </rich:column>


                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemTotalPrice}
                    </f:facet>
                    <h:outputText value="#{_orderItem.totalMoney}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                    <f:facet name="footer">
                        <h:outputText value="#{orderShip.overlyItemTotalPrice}">
                            <f:convertNumber locale="#{calendarBean.locale}"
                                             type="currency" groupingUsed="true"/>
                        </h:outputText>
                    </f:facet>
                </rich:column>


                <rich:column style="text-align: center;">
                    <f:facet name="header">

                    </f:facet>

                    <a:commandButton image="/img/delete.png" title="#{messages.deleteOverlyPrice}"
                                     execute="@form"
                                     action="#{orderShip.deleteOrderItem}" immediate="true"
                                     render="overlyItems,overlyOrderItems,orderTotalPrice">
                        <a:attachQueue requestDelay="0"/>

                    </a:commandButton>


                </rich:column>
            </rich:dataTable>
        </h:form>
    </h:panelGrid>
</rich:panel>

<br/>
<rich:collapsiblePanel switchType="client" header="#{messages.order_ship_info}">

    <ui:include src="/layout/erp/orderNeedResInfo.xhtml">
        <ui:param name="needRes" value="#{dispatchHome.instance.needRes}"/>
    </ui:include>

    <ui:include src="/layout/erp/orderDispatchInfo.xhtml">
        <ui:param name="dispatch" value="#{dispatchHome.instance}"/>
    </ui:include>

    <div style="clear: both"/>

</rich:collapsiblePanel>

<br/>
<rich:collapsiblePanel switchType="client" header="#{messages.order_info}">



    <s:decorate template="/layout/erp/publicOrderInfo.xhtml">
        <div style="clear: both;"/>
        <s:decorate template="/layout/view-details.xhtml">
            <ui:include src="/layout/erp/CustomerView.xhtml">

                <ui:param name="customer" value="#{orderHome.instance.customer}"/>

            </ui:include>
            <ui:param name="labelValue" value="#{orderHome.instance.customer.name}"/>
            <ui:param name="openLabel" value="#{messages.Customer}"/>
            <ui:param name="hideLabel" value="#{messages.detailsHide}#{' '}#{messages.Customer}"/>
        </s:decorate>


        <s:decorate template="/layout/seam-display.xhtml">
            <ui:define name="label">#{messages.order_field_contact}</ui:define>
            <h:outputText value="#{orderHome.instance.contact}"/>
        </s:decorate>

        <s:decorate template="/layout/seam-display.xhtml">
            <ui:define name="label">#{messages.order_field_tel}</ui:define>
            <h:outputText value="#{orderHome.instance.tel}"/>
        </s:decorate>


        <ui:include src="/layout/erp/OrderItemTable.xhtml">
            <ui:param name="orderItems" value="#{orderHome.instance.allOrderItemList}"/>
        </ui:include>

    </s:decorate>

</rich:collapsiblePanel>

</ui:define>

</ui:composition>