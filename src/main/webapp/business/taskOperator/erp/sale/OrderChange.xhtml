<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">


<ui:param name="functionTitle" value="#{messages.orderChange}"/>

<ui:define name="func-body">


<h:form>

    <rich:toolbar>
        <rich:toolbarGroup>
            <a:region>
                <h:panelGrid id="orderTotalPrice" columns="20">
                    #{messages.orderPrice}:
                    <h:outputText value="#{orderChange.orderResTotalMoney}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                    #{' '}
                    <h:selectOneMenu value="#{orderChange.rebateUseMoney}">
                        <f:selectItem itemValue="#{true}" itemLabel="-"/>
                        <f:selectItem itemValue="#{false}" itemLabel="%"/>
                        <a:ajax event="click" listener="#{orderChange.calcByRate}"
                                render="orderTotalRebateField,orderTotalPrice"/>
                    </h:selectOneMenu>

                    <a:outputPanel id="orderTotalRebateField" >
                        <h:inputText rendered="#{not orderChange.rebateUseMoney}" value="#{orderChange.totalRebate}"
                                     required="true" size="5" label="#{messages.orderRebate}">
                            <f:convertNumber pattern="#0.##" groupingUsed="false"/>
                            <a:ajax event="blur" execute="@region" listener="#{orderChange.calcByRate}"
                                    render="orderTotalPrice">
                                <a:attachQueue requestDelay="0"/>
                            </a:ajax>
                            <rich:validator/>
                            <f:validateDoubleRange minimum="0" maximum="100"/>
                            <rich:placeholder value="#{messages.orderRebate}"/>
                        </h:inputText>
                        <h:inputText rendered="#{orderChange.rebateUseMoney}" value="#{orderChange.totalRebateMoney}"
                                     required="true" size="5" label="#{messages.orderRebate}">
                            <f:convertNumber type="currency" locale="#{calendarBean.locale}"
                                             currencySymbol="" groupingUsed="false"/>
                            <a:ajax event="blur" execute="@region" listener="#{orderChange.calcByRate}"
                                    render="orderTotalPrice">
                                <a:attachQueue requestDelay="0"/>
                            </a:ajax>
                            <rich:validator/>
                            <rich:placeholder value="#{messages.orderRebate}"/>
                        </h:inputText>


                    </a:outputPanel>
                    <rich:message for="orderTotalRebateField" styleClass="message-icon"
                                  showDetail="true" showSummary="true" tooltip="true"/>
                    =
                    <h:inputText id="orderMoneyField" value="#{orderChange.orderTotalMoney}"
                                 label="#{messages.orderItemPrice}" required="true" size="9">
                        <f:convertNumber locale="#{calendarBean.locale}" currencySymbol=""
                                         type="currency" groupingUsed="false"/>
                        <a:ajax listener="#{orderChange.calcByOrderTotalMoney}" event="blur" execute="@region"
                                render="orderTotalPrice">
                            <a:attachQueue requestDelay="0"/>
                        </a:ajax>
                        <rich:validator/>
                        <rich:placeholder value="#{messages.orderItemPrice}"/>
                    </h:inputText>
                    <rich:message for="orderMoneyField" styleClass="message-icon"
                                  showDetail="true" showSummary="true" tooltip="true"/>
                </h:panelGrid>
            </a:region>
        </rich:toolbarGroup>

        <rich:toolbarGroup location="right">
            <s:button styleClass="toolBarBtn" value="#{messages.reset}" includePageParams="false"/>
            <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                      view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>
            <h:commandButton id="dispatchButton" styleClass="toolBarBtn" value="#{messages.Dispatch}"
                             action="#{orderReSenderCreate.beginDispatch}" disabled="#{not orderChange.reSend}"/>

            <h:commandButton styleClass="toolBarBtn" value="#{messages.complete}"
                             action="#{orderChange.complete}">
            </h:commandButton>
        </rich:toolbarGroup>
    </rich:toolbar>
    <br/>
    <a:outputPanel id="newNeedResPanel">
        <rich:panel rendered="#{orderChange.reSend}">

            <h:panelGrid columns="3">
                <s:decorate template="/layout/edit.xhtml">


                    <h:selectBooleanCheckbox required="true" value="#{needResHome.instance.fareByCustomer}">
                        #{messages.order_fare_by_customer}
                    </h:selectBooleanCheckbox>
                </s:decorate>
                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.storeOutLimitDate}</ui:define>

                    <rich:calendar id="orderSendLimitDateField"
                                   enableManualInput="true"
                                   inputSize="10"
                                   timeZone="#{calendarBean.timeZone}" locale="#{calendarBean.locale}"
                                   showApplyButton="#{calendarBean.showApply}" popup="#{calendarBean.popup}"
                                   datePattern="#{messages.datePattern}"
                                   required="true"
                                   label="#{messages.storeOutLimitDate}"
                                   value="#{needResHome.instance.limitTime}">
                    </rich:calendar>
                </s:decorate>


                <s:decorate id="orderPostCodeField" template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.order_field_postCode}</ui:define>
                    <h:inputText value="#{needResHome.instance.postCode}" label="#{messages.order_field_postCode}"
                                 size="10" maxlength="10">
                        <a:ajax event="blur" render="orderPostCodeField"/>
                    </h:inputText>
                </s:decorate>

                <s:decorate id="receiveTelField" template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.order_field_reveiveTel}</ui:define>

                    <rich:autocomplete mode="client" minChars="1" autofill="false"
                                       showButton="true"
                                       selectFirst="true"
                                       required="true"
                                       label="#{messages.order_field_reveiveTel}"
                                       clientFilterFunction="pinyinNameFilter"
                                       autocompleteList="#{customerHome.allTelList}"
                                       value="#{needResHome.instance.receiveTel}"
                                       fetchValue="#{_tel}" var="_tel">

                        <h:outputText value="#{_tel}"/>
                        <a:ajax event="blur"
                                render="receiveContactField,receiveTelField"/>

                        <a:ajax event="selectitem"
                                render="receiveContactField,receiveTelField"/>
                    </rich:autocomplete>

                </s:decorate>

                <s:decorate id="receiveContactField" template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.order_field_reveiveContact}</ui:define>

                    <rich:autocomplete mode="client" minChars="1" autofill="false"
                                       showButton="true"
                                       selectFirst="true"
                                       required="true"
                                       label="#{messages.order_field_reveiveContact}"
                                       clientFilterFunction="pinyinNameFilter"
                                       autocompleteList="#{customerHome.allContactList}"
                                       value="#{needResHome.instance.receivePerson}"
                                       fetchValue="#{_contact}" var="_contact">

                        <h:outputText value="#{_contact}"/>
                        <a:ajax event="blur"
                                render="receiveContactField,receiveTelField"/>
                        <a:ajax event="selectitem"
                                render="receiveContactField,receiveTelField"/>
                    </rich:autocomplete>

                </s:decorate>

            </h:panelGrid>

            <h:panelGrid columns="1">


                <s:decorate id="receiveAddressField" template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.order_field_address}</ui:define>
                    <h:inputText value="#{needResHome.instance.address}" label="#{messages.order_field_address}"
                                 required="true" size="80" maxlength="200">
                        <a:ajax event="blur" render="receiveAddressField"/>
                    </h:inputText>
                </s:decorate>

                <s:decorate template="/layout/edit.xhtml">
                    <ui:define name="label">#{messages.field_memo}</ui:define>
                    <h:inputTextarea label="#{messages.field_memo}"
                                     value="#{needResHome.instance.memo}"
                                     cols="81" rows="2"/>
                </s:decorate>

            </h:panelGrid>


        </rich:panel>
    </a:outputPanel>
</h:form>

<br/>


<ui:include src="/layout/erp/OrderItemTable.xhtml">
    <ui:param name="orderItems" value="#{orderHome.lastNeedRes.orderItemList}"/>
    <ui:param name="totalItemMoney" value="#{orderHome.lastResTotalMoney}"/>
    <ui:param name="showMiddleMoney" value="false"/>
</ui:include>

<br/>

<rich:panel rendered="#{not empty orderChange.overlyItems}">


    <f:facet name="header">
        <span class="required">*</span> #{messages.add_overly_confirm}
    </f:facet>


    <rich:dataTable style="width: 100%" value="#{orderChange.overlyItems}" var="_overly" id="overlyItems"
                    noDataLabel="#{messages.dispatch_overly_empty}">


        <rich:column>
            <f:facet name="header">
                #{messages.StoreRes}
            </f:facet>
            <ui:include src="/layout/erp/StoreResTitle.xhtml">
                <ui:param name="storeRes" value="#{_overly.storeRes}"/>
            </ui:include>
            <f:facet name="footer">
                #{messages.recordTotal}#{orderChange.overlyItems.size}#{messages.item};
            </f:facet>
        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.MasterUnitCount}
            </f:facet>
            #{_overly.displayMasterCount}
        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.AuxUnitCount}
            </f:facet>
            #{_overly.displayAuxCount}

        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.description}
            </f:facet>
            #{_overly.description}
        </rich:column>
    </rich:dataTable>
</rich:panel>

<rich:panel rendered="#{not empty orderChange.oweItems}">


    <f:facet name="header">
        <span class="required">*</span> #{messages.sub_overly_oper}
    </f:facet>


    <rich:dataTable style="width: 100%" value="#{orderChange.oweItems}" var="_overly">


        <rich:column>
            <f:facet name="header">
                #{messages.StoreRes}
            </f:facet>
            <ui:include src="/layout/erp/StoreResTitle.xhtml">
                <ui:param name="storeRes" value="#{_overly.storeRes}"/>
            </ui:include>
            <f:facet name="footer">
                #{messages.recordTotal}#{orderChange.oweItems.size}#{messages.item};
            </f:facet>
        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.MasterUnitCount}
            </f:facet>
            #{_overly.displayMasterCount}
        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.AuxUnitCount}
            </f:facet>
            #{_overly.displayAuxCount}

        </rich:column>

        <rich:column>
            <f:facet name="header">
                #{messages.description}
            </f:facet>
            #{_overly.description}
        </rich:column>
    </rich:dataTable>

    <h:form>
        <s:decorate template="/layout/seam-edit.xhtml">
            <ui:define name="label">
                #{messages.sub_overly_oper_type}
            </ui:define>
            <h:selectOneMenu value="#{orderChange.reSend}" required="true"
                             disabled="#{orderHome.instance.payType eq 'PAY_FIRST'}"
                             label="#{messages.sub_overly_oper_type}">
                <f:selectItem itemLabel="#{messages.sub_overly_oper_render_true}" itemValue="#{true}"/>
                <f:selectItem itemLabel="#{messages.sub_overly_oper_render_false}" itemValue="#{false}"/>
                <a:ajax event="valueChange" listener="#{orderChange.calcByRate}"
                        render="subOverlyOrderItem,orderTotalPrice,newNeedResPanel,dispatchButton"/>
            </h:selectOneMenu>
        </s:decorate>

        <div style="clear: both"/>

        <a:outputPanel id="subOverlyOrderItem">
            <rich:dataTable rendered="#{orderChange.reSend}" style="width: 100%" value="#{reSendOrder}"
                            var="_reSendItem">
                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItems}
                    </f:facet>
                    #{messages.StoreRes}:
                    <ui:include src="/layout/erp/StoreResTitle.xhtml">
                        <ui:param name="storeRes" value="#{_reSendItem.storeRes}"/>
                    </ui:include>
                    <f:facet name="footer">
                        #{messages.recordTotal} #{reSendOrder.size} #{messages.item}
                    </f:facet>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemCount}
                    </f:facet>
                    <h:outputText value="#{_reSendItem.useUnitCount}">
                        <f:convertNumber pattern="#0.####"/>
                    </h:outputText>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.Res_Unit}
                    </f:facet>

                    <s:decorate template="/layout/single-edit.xhtml">
                        <h:selectOneMenu label="#{messages.Res_Unit}" style="min-width: 70px"
                                         value="#{_reSendItem.resUnit}"
                                         required="true">
                            <s:selectItems value="#{_reSendItem.storeRes.res.unitGroup.resUnitList}"
                                           var="_unit" label="#{_unit.name}"/>
                            <a:ajax event="valueChange" listener="#{orderChange.calcByRate}"
                                    render="orderTotalPrice,subOverlyOrderItem"/>
                            <f:converter converterId="erpEntityConverter"/>
                        </h:selectOneMenu>
                    </s:decorate>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemUnitPrice}
                    </f:facet>
                    <s:decorate template="/layout/single-edit.xhtml">
                        <h:inputText value="#{_reSendItem.money}" required="true" size="10"
                                     label="#{messages.orderItemUnitPrice}">
                            <f:convertNumber type="currency" locale="#{calendarBean.locale}" currencySymbol=""
                                             groupingUsed="false"/>
                            <a:ajax event="blur" listener="#{orderChange.calcByRate}"
                                    render="orderTotalPrice,subOverlyOrderItem"/>
                        </h:inputText>
                    </s:decorate>
                </rich:column>


                <rich:column>
                    <f:facet name="header">
                        #{messages.orderItemPriceRebate}
                    </f:facet>
                    <s:decorate template="/layout/single-edit.xhtml">
                        <h:inputText value="#{_reSendItem.rebate}" label="#{messages.orderItemPriceRebate}"
                                     size="5" required="true">
                            <f:validateLongRange minimum="0" maximum="100"/>
                            <f:convertNumber pattern="#0.###"/>
                            <a:ajax event="blur" listener="#{orderChange.calcByRate}"
                                    render="orderTotalPrice,subOverlyOrderItem"/>
                        </h:inputText>
                    </s:decorate>
                </rich:column>

                <rich:column style="text-align: right">
                    <f:facet name="header">
                        #{messages.orderItemTotalPrice}
                    </f:facet>
                    <h:outputText value="#{_reSendItem.totalPrice}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                    <f:facet name="footer">
                        <h:outputText value="#{orderReSenderCreate.reSenderTotalMoney}">
                            <f:convertNumber locale="#{calendarBean.locale}"
                                             type="currency" groupingUsed="true"/>
                        </h:outputText>
                    </f:facet>
                </rich:column>

                <rich:column style="text-align: center;">
                    <f:facet name="header">

                    </f:facet>
                    <a:commandButton image="/img/match_price.png"
                                     title="#{messages.splitOrderItem}"
                                     oncomplete="#{rich:component('splitItemCountInput')}.show();"
                                     render="splitItemCountInput_inputs"
                                     action="#{orderReSenderCreate.beginSplitOrderItem}">
                        <a:attachQueue requestDelay="0"/>
                    </a:commandButton>

                </rich:column>

            </rich:dataTable>
        </a:outputPanel>

    </h:form>

</rich:panel>

<br/>

<rich:panel>
    <f:facet name="header">
        <span class="required">*</span> #{messages.new_orderItems}
    </f:facet>
    <h:form>
        <rich:dataTable id="newOrderItemsTable" style="width:100%" value="#{newOrderItems}" var="_item">
            <rich:column>
                <f:facet name="header">
                    #{messages.orderItems}
                </f:facet>

                #{messages.StoreRes}:
                <ui:include src="/layout/erp/StoreResTitle.xhtml">
                    <ui:param name="storeRes" value="#{_item.storeRes}"/>
                </ui:include>


                <f:facet name="footer">
                    #{messages.recordTotal} #{newOrderItems.size} #{messages.item}
                </f:facet>
            </rich:column>
            <rich:column>
                <f:facet name="header">
                    #{messages.orderItemCount}
                </f:facet>
                <h:outputText value="#{_item.useUnitCount}">
                    <f:convertNumber pattern="#0.####"/>
                </h:outputText>
            </rich:column>

            <rich:column>
                <f:facet name="header">
                    #{messages.Res_Unit}
                </f:facet>
                <s:decorate template="/layout/single-edit.xhtml">
                    <h:selectOneMenu label="#{messages.Res_Unit}" style="min-width: 70px" value="#{_item.resUnit}"
                                     required="true">
                        <s:selectItems value="#{_item.storeRes.res.unitGroup.resUnitList}"
                                       var="_unit" label="#{_unit.name}"/>
                        <a:ajax event="valueChange" listener="#{orderChange.calcByRate}"
                                render="orderTotalPrice,newOrderItemsTable"/>
                        <f:converter converterId="erpEntityConverter"/>
                    </h:selectOneMenu>
                </s:decorate>
            </rich:column>

            <rich:column>
                <f:facet name="header">
                    #{messages.orderItemUnitPrice}
                </f:facet>
                <s:decorate template="/layout/single-edit.xhtml">
                    <h:inputText value="#{_item.money}" required="true" size="10"
                                 label="#{messages.orderItemUnitPrice}">
                        <f:convertNumber type="currency" locale="#{calendarBean.locale}" currencySymbol=""
                                         groupingUsed="false"/>
                        <a:ajax event="blur" listener="#{orderChange.calcByRate}"
                                render="orderTotalPrice,newOrderItemsTable"/>
                    </h:inputText>
                </s:decorate>
            </rich:column>

            <rich:column>
                <f:facet name="header">
                    #{messages.orderItemPriceRebate}
                </f:facet>
                <s:decorate template="/layout/single-edit.xhtml">
                    <h:inputText value="#{_item.rebate}" label="#{messages.orderItemPriceRebate}"
                                 size="5" required="true">
                        <f:validateLongRange minimum="0" maximum="100"/>
                        <f:convertNumber pattern="#0.###"/>
                        <a:ajax event="blur" listener="#{orderChange.calcByRate}"
                                render="orderTotalPrice,newOrderItemsTable"/>
                    </h:inputText>
                </s:decorate>
            </rich:column>

            <rich:column style="text-align: right">
                <f:facet name="header">
                    #{messages.orderItemTotalPrice}
                </f:facet>

                <h:outputText value="#{_item.totalPrice}">
                    <f:convertNumber locale="#{calendarBean.locale}"
                                     type="currency" groupingUsed="true"/>
                </h:outputText>
                <f:facet name="footer">
                    <h:outputText value="#{orderChange.newItemTotalMoney}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                </f:facet>
            </rich:column>

            <rich:column style="text-align: center;">
                <f:facet name="header">

                </f:facet>
                <a:commandButton image="/img/match_price.png"
                                 title="#{messages.splitOrderItem}"
                                 oncomplete="#{rich:component('splitItemCountInput')}.show();"
                                 render="splitItemCountInput_inputs"
                                 action="#{orderChange.beginSplitOrderItem}">
                    <a:attachQueue requestDelay="0"/>
                </a:commandButton>
            </rich:column>

        </rich:dataTable>
    </h:form>
</rich:panel>

<s:decorate template="/layout/edit-modalpanel.xhtml">
    <ui:param name="panelId" value="splitItemCountInput"/>
    <ui:param name="panelTitle" value="#{messages.splitOrderItem}"/>

    <ui:define name="controls">
        <a:commandButton immediate="true"
                         execute="@this" image="/img/close.png"
                         onclick="#{rich:component(panelId)}.hide(); return false;">
        </a:commandButton>
    </ui:define>

    <div style="clear: both"/>

    <ui:include src="/layout/erp/res/StoreResCountInput.xhtml">

        <ui:param name="inputValue" value="#{orderItemSplit.newOrderItem}"/>
        <ui:param name="formatTemplate" value="/layout/edit.xhtml"/>
        <ui:param name="countLableStyleClass" value="small_name"/>
    </ui:include>

    <ui:define name="actionButtons">
        <a:commandButton immediate="true" execute="@this" value="#{messages.cancel}"
                         onclick="#{rich:component(panelId)}.hide(); return false;"/>
        <a:commandButton value="#{messages.ok}" execute="@form"
                         data="#{actionExecuteState.lastState}"

                         render="orderTotalPrice,newOrderItemsTable,subOverlyOrderItem"
                         oncomplete="if (event.data == 'success')#{rich:component(panelId)}.hide();"
                         action="#{orderItemSplit.splitOrderItem}">
            <a:attachQueue requestDelay="0"/>
        </a:commandButton>
    </ui:define>
</s:decorate>

<br/>
<rich:collapsiblePanel switchType="client" expanded="false" header="#{messages.order_info}">
    <s:decorate template="/layout/erp/publicOrderInfo.xhtml">
        <div style="clear: both;"/>
        <s:decorate template="/layout/view-details.xhtml">
            <ui:include src="/layout/erp/CustomerView.xhtml">

                <ui:param name="customer" value="#{orderHome.instance.customer}"/>

            </ui:include>
            <ui:param name="labelValue" value="#{orderHome.instance.customer.name}"/>
            <ui:param name="openLabel" value="#{messages.Customer}"/>
            <ui:param name="hideLabel" value="#{messages.detailsHide}#{' '}#{messages.Customer}"/>
        </s:decorate>

        <ui:include src="/layout/erp/OrderItemTable.xhtml">
            <ui:param name="orderItems" value="#{orderHome.instance.allOrderItemList}"/>
            <ui:param name="totalItemMoney" value="#{orderHome.resTotalMoney}"/>
            <ui:param name="totalMiddleMoney" value="#{orderHome.totalItemMiddleMoney}"/>
        </ui:include>
    </s:decorate>
</rich:collapsiblePanel>

</ui:define>

</ui:composition>