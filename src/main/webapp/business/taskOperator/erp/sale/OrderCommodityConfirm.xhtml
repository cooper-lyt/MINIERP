<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.org/schema/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich" xmlns:a="http://richfaces.org/a4j"
                template="/layout/full-template.xhtml">

<ui:param name="functionTitle" value="#{messages.orderCommodityConfirm}"/>

<ui:define name="func-body">

    <h:outputStylesheet>
        .rf-tb-emp {
            border: 0 none !important;
            width: 100% !important;
        }
    </h:outputStylesheet>

    <s:decorate template="/layout/edit-modalpanel.xhtml">
        <ui:param name="panelId" value="sendEmpSelectPanel"/>
        <ui:param name="panelTitle" value="#{messages.dispatch_field_shipEmp}"/>
        <ui:define name="controls">
            <a:commandButton immediate="true"
                             execute="@this" image="/img/close.png"
                             onclick="#{rich:component(panelId)}.hide(); return false;">

                <a:attachQueue requestDelay="0"/>
            </a:commandButton>
        </ui:define>


        <ui:define name="formContent">
            <rich:panel style="width: 300px;height: 360px">
                <rich:tree
                        var="_node"
                        value="#{employeeTree}"
                        nodeType="#{_node.type}"
                        onbeforeselectionchange="if (arguments[2].newSelection[0].__canBeToggled()) { arguments[2].newSelection[0].toggle();return false;} "
                        toggleType="client"
                        selectionType="client">
                    <rich:treeNode type="org">
                        #{_node.org.name}
                    </rich:treeNode>

                    <rich:treeNode type="emp">

                        <a:commandLink value="#{_node.emp.person.name})(#{_node.emp.id})" execute="@this" immediate="true"
                                       render="sendInfos" action="#{orderCommodityConfirm.selectSendEmployee}"
                                       oncomplete="#{rich:component('sendEmpSelectPanel')}.hide();">
                            <a:attachQueue requestDelay="0"/>
                            <a:param value="#{_node.emp.id}" assignTo="#{orderCommodityConfirm.selectSendEmpId}"/>
                        </a:commandLink>

                    </rich:treeNode>
                </rich:tree>
            </rich:panel>
        </ui:define>
    </s:decorate>


    <h:form>
        <rich:toolbar>
            <rich:toolbarGroup>
                <h:outputText value="#{messages.order_proxy_fare}"
                              rendered="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') and orderHome.lastNeedRes.type eq 'ORDER_SEND'}"/>

                <h:outputText value="#{messages[orderHome.lastNeedRes.type.name()]}"
                              rendered="#{not ((orderHome.instance.payType eq 'EXPRESS_PROXY') and orderHome.lastNeedRes.type eq 'ORDER_SEND')}"/>
                <h:inputText id="reveiveFareField" label="#{messages.order_fare}" required="true"
                             value="#{orderHome.masterNeedRes.proxyFare}" size="10"
                             rendered="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') and orderHome.lastNeedRes.type eq 'ORDER_SEND'}">
                    <f:convertNumber locale="#{calendarBean.locale}" currencySymbol=""
                                     type="currency" groupingUsed="false"/>
                    <rich:placeholder value="#{messages.order_proxy_fare}"/>
                    <rich:validator/>
                </h:inputText>
                <rich:message for="reveiveFareField" styleClass="message-icon"
                              showDetail="true" showSummary="true" tooltip="true"/>
            </rich:toolbarGroup>

            <rich:toolbarGroup location="right">
                <h:panelGroup>
                    <s:button styleClass="toolBarBtn" value="#{messages.cancel}" propagation="end"
                              view="#{empty from ? '/func/system/business/task.xhtml' : from}"/>
                    <h:commandButton styleClass="toolBarBtn" value="#{messages.complete}"
                                     action="#{orderCommodityConfirm.complete}"/>
                </h:panelGroup>
            </rich:toolbarGroup>
        </rich:toolbar>


        <br/>
        <rich:messages ajaxRendered="true" globalOnly="true"/>

        <br/>


        <a:outputPanel id="sendInfos"
                       rendered="#{not ((orderHome.instance.payType eq 'EXPRESS_PROXY') and orderHome.lastNeedRes.type eq 'ORDER_SEND')}">


            <rich:dataTable style="width: 100%" value="#{orderHome.lastNeedRes.dispatchList}" var="_dispatch">
                <f:facet name="header">
                    #{messages[orderHome.lastNeedRes.type.name()]}
                </f:facet>
                <f:facet name="footer">
                    <a:outputPanel id="totalFare">
                    <h:outputText value="#{orderHome.lastNeedResTotalFare}">
                        <f:convertNumber locale="#{calendarBean.locale}"
                                         type="currency" groupingUsed="true"/>
                    </h:outputText>
                    </a:outputPanel>
                </f:facet>
                <rich:column>
                    <f:facet name="header">
                        #{messages.dispatch_field_store}
                    </f:facet>
                    #{_dispatch.store.name}
                </rich:column>
                <rich:column>
                    <f:facet name="header">
                        #{messages.order_field_deliveryType}
                    </f:facet>
                    #{messages[_dispatch.deliveryType.name()]}
                </rich:column>
                <rich:column>
                    <f:facet name="header">
                        #{messages.dispatch_field_shipDate}
                    </f:facet>

                    <s:decorate template="/layout/single-edit.xhtml">
                        <rich:calendar enableManualInput="true"
                                       inputSize="10"
                                       timeZone="#{calendarBean.timeZone}" locale="#{calendarBean.locale}"
                                       showApplyButton="#{calendarBean.showApply}" popup="#{calendarBean.popup}"
                                       datePattern="#{messages.datePattern}"
                                       disabled="#{_dispatch.needRes.fareByCustomer or (not _dispatch.deliveryType.haveFare)}"
                                       label="#{messages.dispatch_field_shipDate}"
                                       value="#{_dispatch.sendTime}">
                            <rich:validator event="change"/>
                            <rich:placeholder
                                    value="#{_needRes.fareByCustomer ? messages.order_fare_by_customer : (_dispatch.deliveryType.haveFare ? messages.dispatch_field_shipDate : messages[_dispatch.deliveryType.name()])}"/>
                        </rich:calendar>
                    </s:decorate>

                </rich:column>
                <rich:column>
                    <f:facet name="header">
                        #{messages.dispatch_field_shipEmp}
                    </f:facet>
                    <a:commandLink
                            disabled="#{_dispatch.needRes.fareByCustomer or (not _dispatch.deliveryType.haveFare)}"
                            value="#{empty _dispatch.sendEmp ? messages.noSelectLabelShort : dictionary.getEmpNameById(_dispatch.sendEmp)}"
                            oncomplete="#{rich:component('sendEmpSelectPanel')}.show()" immediate="true"
                            execute="@this" render="sendEmpSelectPanel_form">
                        <a:attachQueue requestDelay="0"/>
                        <a:param value="#{_dispatch.id}" assignTo="#{orderCommodityConfirm.selectDispatchId}"/>
                    </a:commandLink>
                </rich:column>

                <rich:column>
                    <f:facet name="header">
                        #{messages.dispatch_field_Fare}
                    </f:facet>
                    <s:decorate template="/layout/single-edit.xhtml">
                        <h:inputText
                                disabled="#{_dispatch.needRes.fareByCustomer or (not _dispatch.deliveryType.haveFare)}"
                                value="#{_dispatch.fare}" size="10" label="#{messages.dispatch_field_Fare}">
                            <f:convertNumber locale="#{calendarBean.locale}" currencySymbol=""
                                             type="currency" groupingUsed="false"/>
                            <a:ajax event="blur" render="sendInfos"/>
                        </h:inputText>
                    </s:decorate>
                </rich:column>
            </rich:dataTable>


    </a:outputPanel>
</h:form>
<br/>
<rich:dataTable style="width: 100%" value="#{allShipStoreResEntrySet}" var="_entry">
    <f:facet name="header">#{messages.order_ship_all_storeRes}</f:facet>

    <rich:column>
        <f:facet name="header"> #{messages.StoreRes}</f:facet>
        <ui:include src="/layout/erp/StoreResTitle.xhtml">
            <ui:param name="storeRes" value="#{_entry.key}"/>
        </ui:include>

    </rich:column>

    <rich:column>
        <f:facet name="header">#{messages.stockOutCount}</f:facet>
        #{_entry.value.masterDisplayCount}
    </rich:column>

    <rich:column>
        <f:facet name="header"> #{messages.AuxUnitCount}</f:facet>
        #{_entry.value.displayAuxCount}
    </rich:column>
</rich:dataTable>


<br/>
<rich:collapsiblePanel switchType="client" header="#{messages.order_ship_info}">


    <a:repeat value="#{orderHome.instance.needResList}" var="_needRes">

        <ui:include src="/layout/erp/orderNeedResInfo.xhtml">
            <ui:param name="needRes" value="#{_needRes}"/>
        </ui:include>


        <a:repeat value="#{_needRes.dispatchList}" var="_dispatch">

            <div style="clear: both"/>
            <s:decorate template="/layout/view-details.xhtml">
                <ui:param name="openLabel"
                          value="#{messages.dispatch_field_store}: #{'   '}#{_dispatch.store.name}"/>
                <ui:param name="hideLabel"
                          value="#{messages.detailsHide}#{' '}#{messages.dispatch_field_store}"/>

                <ui:include src="/layout/erp/orderDispatchInfo.xhtml">
                    <ui:param name="dispatch" value="#{_dispatch}"/>
                </ui:include>
            </s:decorate>
        </a:repeat>


    </a:repeat>


    <div style="clear: both"/>

</rich:collapsiblePanel>

<br/>
<rich:collapsiblePanel switchType="client" expanded="false" header="#{messages.order_info}">
    <s:decorate template="/layout/erp/publicOrderInfo.xhtml">


    </s:decorate>
</rich:collapsiblePanel>


</ui:define>

        </ui:composition>