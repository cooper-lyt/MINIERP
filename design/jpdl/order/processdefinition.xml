<?xml version="1.0" encoding="UTF-8"?>

<process-definition  xmlns=""  name="order">


	<start-state name="生成订单">
		<transition to="付款方式"></transition>
	</start-state>


	<task-node name="订单出库(1库)">
		<task name="订单出库(1库)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;A&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/SaleStoreOut.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{storeHome.getStoreRole('A')}"></assignment>
		</task>
		<transition to="发货方式(1库)"></transition>
	</task-node>

	<task-node name="订单收款">
		<task name="订单收款">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/finance/ReceivablesOfOrder.xhtml&quot;}
			</description>
			<assignment pooled-actors="erp.finance.cashier"></assignment>
		</task>
		<transition to="发货判断"></transition>
	</task-node>

	<task-node name="客户收货确认">
		<task name="客户收货确认">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/sale/OrderCommodityConfirm.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<event type="process-start">
			<mail actors=""></mail>
		</event>
		<transition to="收货确认"></transition>
	</task-node>

	<task-node name="订单出库(2库)">
		<task name="订单出库(2库)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;B&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/SaleStoreOut.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{storeHome.getStoreRole('B')}"></assignment>
		</task>
		<transition to="发货方式(2库)"></transition>
	</task-node>

	<task-node name="订单出库(天津)">
		<task name="订单出库(天津)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;C&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/SaleStoreOut.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{storeHome.getStoreRole('C')}"></assignment>
		</task>
		<transition to="发货方式(天津)"></transition>
	</task-node>

	<join name="join2">
		<transition to="订单完成"></transition>
	</join>

	<join name="join3">
		<transition to="发货情况判断"></transition>
	</join>

	<fork name="fork2">
		<transition to="出库判断(1库)" name="出库(1库)"></transition>
		<transition to="出库判断(2库)" name="出库(2库)"></transition>
		<transition to="出库判断(天津)" name="出库(天冿)"></transition>
		<transition to="出库判断(公司)" name="出库(公司)"></transition>
	</fork>

	<decision name="出库判断(1库)">
		<transition to="出库完成(1库)">
			<condition expression="#{not needResHome.needStoreOut('A')}"></condition>
		</transition>
		<transition to="订单出库(1库)" name="出库">
			<condition expression="#{needResHome.needStoreOut('A')}"></condition>
		</transition>
	</decision>

	<task-node name="订单调度">
		<task name="订单调度">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/SaleDispatch.xhtml&quot;}
			</description>
			<assignment pooled-actors="erp.storage.dispatch"></assignment>
		</task>
		<transition to="fork2"></transition>
	</task-node>

	<decision name="出库判断(2库)">
		<transition to="订单出库(2库)" name="出库">
			<condition expression="#{needResHome.needStoreOut('B')}"></condition>
		</transition>
		<transition to="出库完成(2库)">
			<condition expression="#{not needResHome.needStoreOut('B')}"></condition>
		</transition>
	</decision>

	<decision name="出库判断(天津)">
		<transition to="订单出库(天津)" name="出库">
			<condition expression="#{needResHome.needStoreOut('C')}"></condition>
		</transition>
		<transition to="出库完成(天津)">
			<condition expression="#{not needResHome.needStoreOut('C')}"></condition>
		</transition>
	</decision>

	<node name="出库完成(1库)">
		<transition to="join3"></transition>
	</node>

	<node name="出库完成(2库)">
		<transition to="join3"></transition>
	</node>

	<node name="出库完成(天津)">
		<transition to="join3"></transition>
	</node>

	<fork name="fork1">
		<transition to="订单收款" name="收款"></transition>
		<transition to="客户收货确认" name="收货确认"></transition>
	</fork>

	<decision name="付款方式">
		<transition to="订单收款" name="款到发货">
			<condition expression="#{(orderHome.instance.payType eq 'PAY_FIRST') and (not orderHome.zeroPriceOrder) and not orderHome.instance.moneyComplete}"></condition>
		</transition>
		<transition to="调度判断" name="先货">
			<condition expression="#{orderHome.instance.moneyComplete or ((not (orderHome.instance.payType eq 'PAY_FIRST') or (orderHome.zeroPriceOrder) ) and (not orderHome.instance.earnestFirst))}"></condition>
		</transition>
		<transition to="订金收款" name="订金发货">
			<condition expression="#{not (orderHome.instance.payType eq 'PAY_FIRST') and (orderHome.instance.earnestFirst) and not orderHome.instance.moneyComplete}"></condition>
		</transition>
	</decision>

	<decision name="收货确认">
		<transition to="join2" name="未(欠)付款">
			<condition expression="#{not orderHome.instance.moneyComplete and not (orderHome.instance.payType eq 'EXPRESS_PROXY')}"></condition>
		</transition>
		<transition to="订单完成" name="已付款">
			<condition expression="#{orderHome.instance.moneyComplete}"></condition>
		</transition>
		<transition to="订单收款" name="代办货款">
			<condition expression="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') and (not orderHome.instance.moneyComplete)}"></condition>
		</transition>
	</decision>

	<decision name="发货判断">
		<transition to="join2" name="已发货">
			<condition expression="#{orderHome.haveShip and (not (orderHome.instance.payType eq 'PAY_FIRST')) and (not (orderHome.instance.payType eq 'EXPRESS_PROXY'))}"></condition>
		</transition>
		<transition to="调度判断" name="款到发货">
			<condition expression="#{orderHome.instance.payType eq 'PAY_FIRST' }"></condition>
		</transition>
		<transition to="订单完成" name="代收货款或自提">
			<condition expression="#{(orderHome.instance.payType eq 'EXPRESS_PROXY') or (not orderHome.haveShip)}"></condition>
		</transition>
	</decision>

	<task-node name="订金收款">
		<task name="订金收款">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;], &quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/finance/ReceiveOrderEarnest.xhtml&quot;}
			</description>
			<assignment pooled-actors="erp.finance.cashier"></assignment>
		</task>
		<transition to="调度判断"></transition>
	</task-node>

	<task-node name="订单发货(1库)">
		<task name="订单发货(一库)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;A&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/OrderShip.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<transition to="出库完成(1库)"></transition>
	</task-node>

	<decision name="发货方式(1库)">
		<transition to="出库完成(1库)">
			<condition expression="#{(not dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
		<transition to="订单发货(1库)" name="发货">
			<condition expression="#{(dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
	</decision>

	<decision name="发货方式(2库)">
		<transition to="出库完成(2库)" name="无发货">
			<condition expression="#{(not dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
		<transition to="订单发货(2库)">
			<condition expression="#{(dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
	</decision>

	<decision name="发货方式(天津)">
		<transition to="出库完成(天津)">
			<condition expression="#{(not dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
		<transition to="订单发货(天津)" name="发货">
			<condition expression="#{(dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
	</decision>

	<task-node name="订单发货(2库)">
		<task name="订单发货(2库)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;B&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/OrderShip.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<transition to="出库完成(2库)"></transition>
	</task-node>

	<task-node name="订单发货(天津)">
		<task name="订单发货(天津)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;C&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/OrderShip.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<transition to="出库完成(天津)"></transition>
	</task-node>

	<decision name="调度判断">
		<transition to="fork2" name="已调度">
			<condition expression="#{orderHome.lastNeedRes.status eq 'DISPATCHED'}"></condition>
		</transition>
		<transition to="订单调度">
			<condition expression="#{not (orderHome.lastNeedRes.status eq 'DISPATCHED')}"></condition>
		</transition>
	</decision>

	<decision name="付款判断">
		<transition to="fork1">
			<condition expression="#{orderHome.haveShip and (not orderHome.instance.moneyComplete) and (not (orderHome.instance.payType eq 'EXPRESS_PROXY'))}"></condition>
		</transition>
		<transition to="订单完成" name="已付款自提">
			<condition expression="#{not orderHome.haveShip and orderHome.instance.moneyComplete}"></condition>
		</transition>
		<transition to="订单收款" name="未(欠)付款自提">
			<condition expression="#{not orderHome.haveShip and (not orderHome.instance.moneyComplete)}"></condition>
		</transition>
		<transition to="客户收货确认" name="已付款或代办货款">
			<condition expression="#{orderHome.haveShip and (orderHome.instance.moneyComplete or (orderHome.instance.payType eq 'EXPRESS_PROXY')) }"></condition>
		</transition>
	</decision>

	<decision name="发货情况判断">
		<transition to="付款判断" name="全部发货">
			<condition expression="#{orderHome.instance.allStoreOut}"></condition>
		</transition>
		<transition to="订单更改" name="订单更改">
			<condition expression="#{not orderHome.instance.allStoreOut}"></condition>
		</transition>
	</decision>

	<decision name="重新发货判断">
		<transition to="调度判断" name="需要补发">
			<condition expression="#{not orderHome.instance.allStoreOut}"></condition>
		</transition>
		<transition to="付款判断" name="订单更改">
			<condition expression="#{orderHome.instance.allStoreOut}"></condition>
		</transition>
	</decision>

	<task-node name="订单更改">
		<task name="订单更改">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/sale/OrderChange.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<transition to="重新发货判断"></transition>
	</task-node>

	<decision name="出库判断(公司)">
		<transition to="订单出库(公司)" name="出库">
			<condition expression="#{needResHome.needStoreOut('D')}"></condition>
		</transition>
		<transition to="出库完成(公司)" name="无出库">
			<condition expression="#{not needResHome.needStoreOut('D')}"></condition>
		</transition>
	</decision>

	<task-node name="订单出库(公司)">
		<task name="订单出库(公司)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;D&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/SaleStoreOut.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{storeHome.getStoreRole('D')}"></assignment>
		</task>
		<transition to="发货方式(公司)"></transition>
	</task-node>

	<decision name="发货方式(公司)">
		<transition to="订单发货(公司)" name="发货">
			<condition expression="#{(dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
		<transition to="出库完成(公司)">
			<condition expression="#{not (dispatchHome.instance.deliveryType.ship) }"></condition>
		</transition>
	</decision>

	<node name="出库完成(公司)">
		<transition to="join3"></transition>
	</node>

	<task-node name="订单发货(公司)">
		<task name="订单发货(公司)">
			<description>
				{&quot;businessName&quot;:&quot;销售订单&quot;,&quot;businessKey&quot;:&quot;#{orderHome.instance.id}&quot;,&quot;tags&quot;:[&quot;#{orderHome.instance.customer.customerArea.name}&quot;],&quot;description&quot;:&quot;#{orderHome.instance.customer.name}&quot;,&quot;storeId&quot;:&quot;D&quot;,&quot;operPage&quot;:&quot;/business/taskOperator/erp/store/OrderShip.xhtml&quot;}
			</description>
			<assignment pooled-actors="#{orderHome.instance.customer.customerArea.role}"></assignment>
		</task>
		<transition to="出库完成(公司)"></transition>
	</task-node>


	<end-state name="订单完成"></end-state>


</process-definition>